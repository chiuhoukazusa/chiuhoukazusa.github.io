<!DOCTYPE html><html lang="简体中文" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>05.载入3D模型|模型加载、简单着色与纹理映射 | Chiuhou个人博客</title><meta name="author" content="Chiuhou"><meta name="copyright" content="Chiuhou"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="05.载入3D模型|模型加载、简单着色与纹理映射 本项目代码已托管至github，将会随着博客实时更新进度 每一节的工程我都会创建一个新的分支，分支名由这一节的数字决定。 https:&#x2F;&#x2F;github.com&#x2F;chiuhoukazusa&#x2F;LearningTinyrenderer&#x2F;tree&#x2F;05 前言 在上一节的工作完成后，我们离渲染出一个正常的三维模型还剩下两步，纹理映射和着色，当然前提是得先把模">
<meta property="og:type" content="article">
<meta property="og:title" content="05.载入3D模型|模型加载、简单着色与纹理映射">
<meta property="og:url" content="https://chiukoukazusa.github.io/2023/01/18/05.%E8%BD%BD%E5%85%A53D%E6%A8%A1%E5%9E%8B%E6%A8%A1%E5%9E%8B%E5%8A%A0%E8%BD%BD%E4%B8%8E%E7%BA%B9%E7%90%86%E6%98%A0%E5%B0%84/index.html">
<meta property="og:site_name" content="Chiuhou个人博客">
<meta property="og:description" content="05.载入3D模型|模型加载、简单着色与纹理映射 本项目代码已托管至github，将会随着博客实时更新进度 每一节的工程我都会创建一个新的分支，分支名由这一节的数字决定。 https:&#x2F;&#x2F;github.com&#x2F;chiuhoukazusa&#x2F;LearningTinyrenderer&#x2F;tree&#x2F;05 前言 在上一节的工作完成后，我们离渲染出一个正常的三维模型还剩下两步，纹理映射和着色，当然前提是得先把模">
<meta property="og:locale">
<meta property="og:image" content="https://chiukoukazusa.github.io/img/favicon.png">
<meta property="article:published_time" content="2023-01-17T21:09:00.000Z">
<meta property="article:modified_time" content="2023-01-17T21:09:47.167Z">
<meta property="article:author" content="Chiuhou">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://chiukoukazusa.github.io/img/favicon.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://chiukoukazusa.github.io/2023/01/18/05.%E8%BD%BD%E5%85%A53D%E6%A8%A1%E5%9E%8B%E6%A8%A1%E5%9E%8B%E5%8A%A0%E8%BD%BD%E4%B8%8E%E7%BA%B9%E7%90%86%E6%98%A0%E5%B0%84/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: true
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '05.载入3D模型|模型加载、简单着色与纹理映射',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-01-18 05:09:47'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.2"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/favicon.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">6</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/%E7%8E%9B%E5%A5%87%E7%8E%9B.jpeg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Chiuhou个人博客</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">05.载入3D模型|模型加载、简单着色与纹理映射</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2023-01-17T21:09:00.000Z" title="Created 2023-01-18 05:09:00">2023-01-18</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2023-01-17T21:09:47.167Z" title="Updated 2023-01-18 05:09:47">2023-01-18</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="05.载入3D模型|模型加载、简单着色与纹理映射"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1>05.载入3D模型|模型加载、简单着色与纹理映射</h1>
<h2 id="本项目代码已托管至github，将会随着博客实时更新进度">本项目代码已托管至github，将会随着博客实时更新进度</h2>
<p>每一节的工程我都会创建一个新的分支，分支名由这一节的数字决定。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/chiuhoukazusa/LearningTinyrenderer/tree/05">https://github.com/chiuhoukazusa/LearningTinyrenderer/tree/05</a></p>
<h2 id="前言">前言</h2>
<p>在上一节的工作完成后，我们离渲染出一个正常的三维模型还剩下两步，纹理映射和着色，当然前提是得先把模型给加载了。</p>
<p>这一节先来尝试纹理映射和简单着色模型。</p>
<p>上一节我们说过要引入一个读取obj的头文件，但我觉得完全可以自己写一个简单的objloader，那就不引入了吧。</p>
<h2 id="OBJ-MTL文件格式">OBJ-MTL文件格式</h2>
<p>obj是最广泛使用的3维模型的格式，实际上obj只是一个纯文本文件，我们可以梳理出他的大致结构。而mtl也是一个纯文本文件，基本上和obj对应，会记录一些材质信息。</p>
<p>我们以games202的吉祥物为例来理解一下obj和mtl文件的结构：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"># Blender v2.90.1 OBJ File: &#x27;Marry.blend&#x27;</span><br><span class="line"># www.blender.org</span><br><span class="line">mtllib Marry.mtl</span><br><span class="line">o 文本</span><br><span class="line">v 0.141234 1.731161 0.414226</span><br><span class="line">v 0.089634 1.739039 0.419244</span><br><span class="line">v 0.094429 1.750718 0.414622</span><br><span class="line">v 0.098634 1.761540 0.410368</span><br><span class="line">......</span><br><span class="line">vt 0.295455 0.000000</span><br><span class="line">vt 0.272727 0.000000</span><br><span class="line">vt 0.284091 0.000000</span><br><span class="line">vt 0.306818 0.000000</span><br><span class="line">......</span><br><span class="line">vn 0.0938 0.6694 0.7369</span><br><span class="line">vn 0.0938 0.6695 0.7369</span><br><span class="line">......</span><br><span class="line">usemtl 材质</span><br><span class="line">s off</span><br><span class="line">f 27/1/1 25/2/1 26/3/1</span><br><span class="line">f 28/4/2 25/2/2 27/1/2</span><br><span class="line">f 29/5/3 25/2/3 28/4/3</span><br><span class="line">f 29/5/4 24/6/4 25/2/4</span><br><span class="line">......</span><br><span class="line">o Body_MC003_Kozakura_Mari_face</span><br><span class="line">v 0.068341 3.046584 0.159396</span><br><span class="line">v 0.052779 3.045725 0.167629</span><br><span class="line">v 0.067417 3.050314 0.165910</span><br><span class="line">......</span><br><span class="line">vt 0.042575 0.471054</span><br><span class="line">vt 0.035748 0.456984</span><br><span class="line">......</span><br><span class="line">vn 0.2510 -0.7130 0.6547</span><br><span class="line">vn 0.3849 -0.6684 0.6365</span><br><span class="line">......</span><br><span class="line">usemtl MC003_Kozakura_Mari</span><br><span class="line">s 1</span><br><span class="line">f 277/275/220 276/276/221 275/277/222</span><br><span class="line">f 278/278/223 275/277/222 276/276/221</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># Blender MTL File: &#x27;Marry.blend&#x27;</span><br><span class="line"># Material Count: 2</span><br><span class="line"></span><br><span class="line">newmtl MC003_Kozakura_Mari</span><br><span class="line">Ns 900.000000</span><br><span class="line">Ka 1.000000 1.000000 1.000000</span><br><span class="line">Kd 0.800000 0.800000 0.800000</span><br><span class="line">Ks 0.000000 0.000000 0.000000</span><br><span class="line">Ke 0.000000 0.000000 0.000000</span><br><span class="line">Ni 1.450000</span><br><span class="line">d 1.000000</span><br><span class="line">illum 1</span><br><span class="line">map_Kd MC003_Kozakura_Mari.png</span><br><span class="line"></span><br><span class="line">newmtl 材质</span><br><span class="line">Ns 900.000000</span><br><span class="line">Ka 1.000000 1.000000 1.000000</span><br><span class="line">Kd 0.270588 0.552941 0.874510</span><br><span class="line">Ks 0.000000 0.000000 0.000000</span><br><span class="line">Ke 0.000000 0.000000 0.000000</span><br><span class="line">Ni 1.450000</span><br><span class="line">d 1.000000</span><br><span class="line">illum 1</span><br></pre></td></tr></table></figure>
<p>省略号省去了数据信息。前者是Marry.obj，后者是Marry.mtl。</p>
<p>我们可以看到除去前几行的注释信息外，最早载入眼帘的是&quot;mtllib Marry.mtl&quot;，mtllib这个关键词意指与这个obj配对的mtl文件，后面跟着的自然是文件的相对路径，当然也可以省略，这样的话就不使用材质。</p>
<p>然后是&quot;o 文本&quot;，这里的o意思是object，一个obj文件里不一定只有一个object，可以有多个object，相当于一个obj里存了多个模型，当然如果只有一个模型的话这行也可以省略。有些obj在o这个层级下还会有g这个层级，意思是group，分组。这个我们暂时先不考虑。</p>
<p>然后就是object下的一行行属性了。v开头的行储存了顶点信息，vt开头的行储存了纹理坐标信息，vn开头的行储存了法线信息。</p>
<p>f开头的行储存了每一个primitive的信息。f后面跟着三份用空格隔开的数据，指的是一个primitive由三个顶点组成，自然就是三角形图元。然后每份数据以v/vt/vn的顺序储存，当然不管是v还是vt或是vn都是以索引的形式储存，不过这个索引是以1开始的。</p>
<p>而且还要注意！这个索引是不会因为object的改变而重新从1开始计数的，可以看到上面的obj文件里，第一个object的索引都是从1开始的，而第二个object的索引就从200多开始了，也可以说，这个索引是全局计数的。</p>
<p>还有就是f上面也有几行信息，usemtl显然就是对应mtl文件里定义的newmtl了，而s指的是光滑组，&quot;s 1&quot;代表软边，&quot;s off&quot;代表硬边。软边和硬边就决定了我们怎么使用法线信息。如果是s off，那么我们定义的法线就是面法线，也就是三角形三个顶点共享一个法线，如果是开启光滑组，那么三角形三个顶点都会有各自的法线，而三角形内部任意一点都是由三个顶点的法线插值出来。不过我们暂时可以不用考虑光滑组的问题，因为我们可以看到，在202吉祥物的obj文件中的两个object，没开光滑组的那个object的f行里每一行的法线顶点索引都是一样的，也就是说f行里已经帮我们解决了光滑组的问题。</p>
<p>关于MTL文件部分可以参考这个链接里的内容。</p>
<p><a target="_blank" rel="noopener" href="http://www.paulbourke.net/dataformats/mtl/">http://www.paulbourke.net/dataformats/mtl/</a></p>
<p>mtl文件详细我们将在后续说到纹理映射的时候再提。</p>
<h2 id="读取OBJ文件">读取OBJ文件</h2>
<p>我们先不管mtl文件，先按之前说的obj文件格式的标准来写一个简单读取obj文件的objloader试试。</p>
<p>我们不考虑组，也就是g这个关键词，那就是一个obj文件中可能存在多个o(object)，每个object又不一定使用一个material，也就是一个o下可能有多个usemtl，我们按这个逻辑可以梳理出一个大体结构：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;tgaimage.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;myEigen.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;geometry.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;material.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> rst</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">class</span> <span class="title class_">Mesh</span></span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">public</span>:</span><br><span class="line">		<span class="built_in">Mesh</span>(<span class="type">const</span> std::string&amp; filename, <span class="type">const</span> std::string&amp; materialname) :<span class="built_in">material</span>(filename, materialname) &#123;&#125;</span><br><span class="line">	<span class="keyword">public</span>:</span><br><span class="line">		std::vector&lt;Triangle&gt; primitives;</span><br><span class="line">		Material material;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">class</span> <span class="title class_">Object</span></span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">public</span>:</span><br><span class="line">		<span class="built_in">Object</span>() &#123;&#125;;</span><br><span class="line">	<span class="keyword">private</span>:</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span>:</span><br><span class="line">		std::vector&lt;Mesh&gt; meshes&#123;&#125;;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">class</span> <span class="title class_">Model</span></span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">public</span>:</span><br><span class="line">		<span class="built_in">Model</span>(<span class="type">const</span> std::string&amp; root, <span class="type">const</span> std::string&amp; filename);</span><br><span class="line">	<span class="keyword">private</span>:</span><br><span class="line">		std::vector&lt;myEigen::Vector3f&gt; verts&#123;&#125;;</span><br><span class="line">		std::vector&lt;myEigen::Vector3f&gt; normals&#123;&#125;;</span><br><span class="line">		std::vector&lt;myEigen::Vector2f&gt; texcoords&#123;&#125;;</span><br><span class="line">	<span class="keyword">public</span>:</span><br><span class="line">		std::vector&lt;Object&gt; objects&#123;&#125;;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Model-&gt;Object-&gt;Mesh</p>
<p>其中Mesh跟material绑定，object用于存储Mesh，Model用于存储Object。</p>
<p>我们目前只支持三角形图元，obj文件其实远不仅仅我们之前说的那些形式，他完全可以支持其他形状的图元，但是我们这里就不考虑了。</p>
<p>material类我们之后讨论mtl读取的时候再作讨论。</p>
<p>我们在model的构造函数里写下具体读取操作：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;objLoader.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sstream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> rst</span><br><span class="line">&#123;</span><br><span class="line">	Model::<span class="built_in">Model</span>(<span class="type">const</span> std::string&amp; root, <span class="type">const</span> std::string&amp; filename)</span><br><span class="line">	&#123;</span><br><span class="line">		std::ifstream obj;</span><br><span class="line">		std::string mtlfilename;</span><br><span class="line">		obj.<span class="built_in">open</span>(root + filename, std::ifstream::in);</span><br><span class="line">		<span class="keyword">if</span> (obj.<span class="built_in">fail</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			std::cerr &lt;&lt; <span class="string">&quot;Cannot open:&quot;</span> &lt;&lt; filename &lt;&lt; std::endl;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		std::string objLine;</span><br><span class="line">		<span class="keyword">while</span> (!obj.<span class="built_in">eof</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			std::<span class="built_in">getline</span>(obj, objLine);</span><br><span class="line">			<span class="function">std::istringstream <span class="title">s</span><span class="params">(objLine)</span></span>;</span><br><span class="line">			std::string header;</span><br><span class="line">			<span class="type">char</span> trash;</span><br><span class="line">			<span class="type">int</span> cur_obj = objects.<span class="built_in">size</span>() - <span class="number">1</span>;</span><br><span class="line">			<span class="type">int</span> cur_mesh;</span><br><span class="line">			<span class="keyword">if</span>(!objects.<span class="built_in">empty</span>()) cur_mesh = objects[cur_obj].meshes.<span class="built_in">size</span>() - <span class="number">1</span>;</span><br><span class="line">			<span class="keyword">if</span> (objLine.<span class="built_in">compare</span>(<span class="number">0</span>, <span class="number">7</span>, <span class="string">&quot;mtllib &quot;</span>) == <span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				s &gt;&gt; header;</span><br><span class="line">				s &gt;&gt; mtlfilename;</span><br><span class="line">				mtlfilename = root + mtlfilename;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span>(objLine.<span class="built_in">compare</span>(<span class="number">0</span>, <span class="number">2</span>, <span class="string">&quot;o &quot;</span>) == <span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				s &gt;&gt; header &gt;&gt; header;</span><br><span class="line">				objects.<span class="built_in">push_back</span>(<span class="built_in">Object</span>());</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (objLine.<span class="built_in">compare</span>(<span class="number">0</span>, <span class="number">2</span>, <span class="string">&quot;v &quot;</span>) == <span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span> (objects.<span class="built_in">empty</span>())</span><br><span class="line">				&#123;</span><br><span class="line">					objects.<span class="built_in">push_back</span>(<span class="built_in">Object</span>());</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="type">float</span> x, y, z;</span><br><span class="line">				s &gt;&gt; header;</span><br><span class="line">				s &gt;&gt; x &gt;&gt; y &gt;&gt; z;</span><br><span class="line">				verts.<span class="built_in">push_back</span>(myEigen::<span class="built_in">Vector3f</span>(x, y, z));</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (objLine.<span class="built_in">compare</span>(<span class="number">0</span>, <span class="number">3</span>, <span class="string">&quot;vt &quot;</span>) == <span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="type">float</span> x, y;</span><br><span class="line">				s &gt;&gt; header;</span><br><span class="line">				s &gt;&gt; x &gt;&gt; y;</span><br><span class="line">				texcoords.<span class="built_in">push_back</span>(myEigen::<span class="built_in">Vector2f</span>(x, y));</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (objLine.<span class="built_in">compare</span>(<span class="number">0</span>, <span class="number">3</span>, <span class="string">&quot;vn &quot;</span>) == <span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="type">float</span> x, y, z;</span><br><span class="line">				s &gt;&gt; header;</span><br><span class="line">				s &gt;&gt; x &gt;&gt; y &gt;&gt; z;</span><br><span class="line">				normals.<span class="built_in">push_back</span>(myEigen::<span class="built_in">Vector3f</span>(x, y, z));</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (objLine.<span class="built_in">compare</span>(<span class="number">0</span>, <span class="number">7</span>, <span class="string">&quot;usemtl &quot;</span>) == <span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				std::string materialName;</span><br><span class="line">				s &gt;&gt; header;</span><br><span class="line">				s &gt;&gt; materialName;</span><br><span class="line">				<span class="function">Mesh <span class="title">mesh</span><span class="params">(mtlfilename, materialName)</span></span>;</span><br><span class="line">				objects[cur_obj].meshes.<span class="built_in">push_back</span>(mesh);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (objLine.<span class="built_in">compare</span>(<span class="number">0</span>, <span class="number">2</span>, <span class="string">&quot;f &quot;</span>) == <span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="type">int</span> v[<span class="number">3</span>], vt[<span class="number">3</span>], vn[<span class="number">3</span>];</span><br><span class="line">				s &gt;&gt; header;</span><br><span class="line">				<span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++)</span><br><span class="line">				&#123;</span><br><span class="line">					s &gt;&gt; v[i] &gt;&gt; trash &gt;&gt; vt[i] &gt;&gt; trash &gt;&gt; vn[i];</span><br><span class="line">				&#125;</span><br><span class="line">				Vertex vertex[<span class="number">3</span>]</span><br><span class="line">				&#123; </span><br><span class="line">					<span class="built_in">Vertex</span>(verts[v[<span class="number">0</span>] - <span class="number">1</span>], <span class="built_in">TGAColor</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>), normals[vn[<span class="number">0</span>] - <span class="number">1</span>], texcoords[vt[<span class="number">0</span>] - <span class="number">1</span>]),</span><br><span class="line">					<span class="built_in">Vertex</span>(verts[v[<span class="number">1</span>] - <span class="number">1</span>], <span class="built_in">TGAColor</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>), normals[vn[<span class="number">1</span>] - <span class="number">1</span>], texcoords[vt[<span class="number">1</span>] - <span class="number">1</span>]),</span><br><span class="line">					<span class="built_in">Vertex</span>(verts[v[<span class="number">2</span>] - <span class="number">1</span>], <span class="built_in">TGAColor</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>), normals[vn[<span class="number">2</span>] - <span class="number">1</span>], texcoords[vt[<span class="number">2</span>] - <span class="number">1</span>])</span><br><span class="line">				&#125;;</span><br><span class="line">				objects[cur_obj].meshes[cur_mesh].primitives.<span class="built_in">push_back</span>(<span class="built_in">Triangle</span>(vertex));</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		obj.<span class="built_in">close</span>();</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>目前我们没有写所谓的纹理映射，但是我们还有一个办法可以检验我们的成果，那就是draw_wireframe()，使用之前写的线框渲染函数来看看究竟能不能读取我们的obj文件。</p>
<p>我们先拿202酱试试刀：</p>
<p><img src="https://raw.githubusercontent.com/chiuhoukazusa/blog_img/main/202301180450657.gif" alt="202girl_wireframe"></p>
<p>非常成功！debug模式下渲染72帧用时13秒，当然我微调了下相机位置，不然202酱起码一半都在屏幕外面。</p>
<p>202酱的obj文件有3万行左右。</p>
<p>我们再来试试另一个有30万行obj文件的神秘嘉宾：</p>
<p><img src="https://raw.githubusercontent.com/chiuhoukazusa/blog_img/main/202301180450731.gif" alt="Melina_wireframe"></p>
<p>debug模式下渲染72帧用时62秒，一下就慢了下来，至于这位神秘嘉宾具体是谁就先不剧透了，主要是因为202酱只有一张纹理贴图，我们为了后续纹理映射的讲解需要更复杂的mtl文件和纹理文件，所以我们又请了一位嘉宾来做我们的讲师。</p>
<h2 id="着色">着色</h2>
<p>当然我们肯定不会满足于仅仅使用线框模式来渲染我们的三维模型。</p>
<p>我们也不能直接就让模型按照我们上一节的代码直接运行，那样看到的只不过是把上面的渲染结果从线框变成一片实心白色的轮廓而已。</p>
<p>我们实际上要体现的是光影关系，也就是光照效果，这就是我们目前要做的，写一个简单的着色模型。</p>
<p>我们先来讨论着色位于渲染管线的哪个位置。或者更具体一点，片元着色器应该位于渲染管线的哪个位置。</p>
<p>片元着色器紧跟着光栅化之后，位于各种测试，包括但不限于深度测试、模板测试等的前面。</p>
<p>我们定义一个函数指针用于存储我们使用的片元着色函数，同时在深度测试前调用我们的片元着色器，因此我们要修改edge walking或者edge equation的函数：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;rasterizer.hpp&quot;</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">namespace</span> rst</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">rasterizer</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">        ......</span><br><span class="line">            std::function&lt;Vertex(fragmentShaderPayload)&gt; fragmentShader;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;rasterizer.cpp&quot;</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">rasterizer::rasterize_edge_walking</span><span class="params">(<span class="type">const</span> Triangle&amp; m, <span class="type">const</span> std::array&lt;myEigen::Vector4f, <span class="number">3</span>&gt;&amp; clipSpacePos)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		...</span><br><span class="line">		<span class="comment">//scan the bottom triangle</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> y = std::<span class="built_in">ceil</span>(t.vertex[<span class="number">0</span>].vertex.y - <span class="number">0.5f</span>); y &lt; std::<span class="built_in">ceil</span>(t.vertex[<span class="number">1</span>].vertex.y - <span class="number">0.5f</span>); y++)</span><br><span class="line">		&#123;</span><br><span class="line">			...</span><br><span class="line">			<span class="keyword">for</span> (<span class="type">int</span> i = std::<span class="built_in">ceil</span>(shortVertex.vertex.x - <span class="number">0.5f</span>); i &lt; std::<span class="built_in">ceil</span>(longVertex.vertex.x - <span class="number">0.5f</span>); i++)</span><br><span class="line">			&#123;</span><br><span class="line">				...</span><br><span class="line">				<span class="function">fragmentShaderPayload <span class="title">payload</span><span class="params">(pixel, light)</span></span>;</span><br><span class="line">				pixel = <span class="built_in">fragmentShader</span>(payload);</span><br><span class="line">				<span class="keyword">if</span> (pixel.vertex.z &gt; z_buffer[<span class="built_in">get_index</span>(i, y)])</span><br><span class="line">				&#123;</span><br><span class="line">					...</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//scan the top triangle</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> y = std::<span class="built_in">ceil</span>(t.vertex[<span class="number">1</span>].vertex.y - <span class="number">0.5f</span>); y &lt; std::<span class="built_in">ceil</span>(t.vertex[<span class="number">2</span>].vertex.y - <span class="number">0.5f</span>); y++)</span><br><span class="line">		&#123;</span><br><span class="line">			...</span><br><span class="line">			<span class="keyword">for</span> (<span class="type">int</span> i = std::<span class="built_in">ceil</span>(shortVertex.vertex.x - <span class="number">0.5f</span>); i &lt; std::<span class="built_in">ceil</span>(longVertex.vertex.x - <span class="number">0.5f</span>); i++)</span><br><span class="line">			&#123;</span><br><span class="line">				...</span><br><span class="line">				<span class="function">fragmentShaderPayload <span class="title">payload</span><span class="params">(pixel, light)</span></span>;</span><br><span class="line">				pixel = <span class="built_in">fragmentShader</span>(payload);</span><br><span class="line">				<span class="keyword">if</span> (pixel.vertex.z &gt; z_buffer[<span class="built_in">get_index</span>(i, y)])</span><br><span class="line">				&#123;</span><br><span class="line">					...</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>光在打到物体表面的着色点再反射到相机的过程可以暂时简单考虑成两个阶段。</p>
<p>第一个阶段我们要计算出着色点接收到的irradiance是多少，也就是有多少的光入射。</p>
<p>第二个阶段我们要计算出有多少光被反射到相机里了。</p>
<h3 id="点光源or平行光">点光源or平行光</h3>
<p>我们来考虑简单的光照情况，点光源和平行光。</p>
<p>先来讨论点光源，一个点光源可以由一个位置和一个intensity定义，intensity可以理解为光源产生出的光的“数量”。</p>
<p>实际上intensity的定义为单位立体角上接收到的光通量(power or radiant flux)的大小，单位为cd(坎德拉)，可以用来更好地代替光通量或者说灯泡功率这个光源变量。</p>
<p><img src="https://raw.githubusercontent.com/chiuhoukazusa/blog_img/main/202301180450840.png" alt="irradiance随着距离平方而减小"></p>
<p>参考这张来自虎书的插图，我们认为一个点光源在所有方向上的intensity都是相同的，或者说，这个点光源是各向同性的。与此相反的是有时候我们会使用一些被称作&quot;spot lights&quot;的光源，它们只在某些方向上投射光线，自然这些光源也就不是各向同性的了。</p>
<p>第一阶段我们需要计算出着色点的irradiance，irradiance的定义是单位面积接收到的光通量。我们整理一下公式：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>d</mi><mi>ω</mi><mo>=</mo><mfrac><mrow><mi>d</mi><mi>A</mi></mrow><msup><mi>r</mi><mn>2</mn></msup></mfrac><mspace linebreak="newline"></mspace><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>n</mi><mi>s</mi><mi>i</mi><mi>t</mi><mi>y</mi><mo>=</mo><mfrac><mrow><mi>d</mi><mi mathvariant="normal">Φ</mi></mrow><mrow><mi>d</mi><mi>ω</mi></mrow></mfrac><mo>=</mo><mfrac><mrow><mi>d</mi><mi mathvariant="normal">Φ</mi><msup><mi>r</mi><mn>2</mn></msup></mrow><mrow><mi>d</mi><mi>A</mi></mrow></mfrac><mspace linebreak="newline"></mspace><mi>i</mi><mi>r</mi><mi>r</mi><mi>a</mi><mi>d</mi><mi>i</mi><mi>a</mi><mi>n</mi><mi>c</mi><mi>e</mi><mo>=</mo><mfrac><mrow><mi>d</mi><mi mathvariant="normal">Φ</mi></mrow><mrow><mi>d</mi><mi>A</mi></mrow></mfrac><mo>=</mo><mfrac><mrow><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>n</mi><mi>s</mi><mi>i</mi><mi>t</mi><mi>y</mi></mrow><msup><mi>r</mi><mn>2</mn></msup></mfrac></mrow><annotation encoding="application/x-tex">d\omega=\frac{dA}{r^2}\\
intensity=\frac{d\Phi}{d\omega}=\frac{d\Phi r^2}{dA}\\
irradiance=\frac{d\Phi}{dA}=\frac{intensity}{r^2}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.0574em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="mord mathnormal">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.0574em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="mord">Φ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.1771em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.4911em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="mord mathnormal">A</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="mord">Φ</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.02778em;">rr</span><span class="mord mathnormal">a</span><span class="mord mathnormal">d</span><span class="mord mathnormal">ian</span><span class="mord mathnormal">ce</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.0574em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="mord mathnormal">A</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="mord">Φ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.0225em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3365em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>但是我们计算出来的irradiance是仅当光垂直射向着色点的情况下的，如果光和着色点法线存在一个夹角，那么我们再乘上夹角跟着色点法线的余弦值即可。</p>
<p>而对于平行光而言，我们认为是一组平行且没有衰减的光线，类似太阳光，自然没有衰减我们也不会关心平行光的位置，我们只需要存储平行光的intensity和方向即可。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Light</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="keyword">virtual</span> ~<span class="built_in">Light</span>() = <span class="keyword">default</span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> std::string <span class="title">getType</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PointLight</span> : <span class="keyword">public</span> Light</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	myEigen::Vector3f position;</span><br><span class="line">	<span class="type">float</span> intensity;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">PointLight</span>(<span class="type">const</span> myEigen::Vector3f&amp; position, <span class="type">const</span> <span class="type">float</span> intensity)</span><br><span class="line">		:<span class="built_in">position</span>(position), <span class="built_in">intensity</span>(intensity)&#123;&#125;</span><br><span class="line">	<span class="function">std::string <span class="title">getType</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> std::<span class="built_in">string</span>(<span class="string">&quot;PointLight&quot;</span>); &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DirectionalLight</span> : <span class="keyword">public</span> Light</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	myEigen::Vector3f direction;</span><br><span class="line">	<span class="type">float</span> intensity;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">DirectionalLight</span>(<span class="type">const</span> myEigen::Vector3f&amp; direction, <span class="type">const</span> <span class="type">float</span> intensity)</span><br><span class="line">		:<span class="built_in">direction</span>(direction), <span class="built_in">intensity</span>(intensity) &#123;&#125;</span><br><span class="line">	<span class="function">std::string <span class="title">getType</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> std::<span class="built_in">string</span>(<span class="string">&quot;DirectionalLight&quot;</span>); &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>我们这节编写代码都将以点光源为主。</p>
<h3 id="Blinn-Phong着色模型">Blinn-Phong着色模型</h3>
<p>接下来我们讨论被反射出来的光有多少，这中间涉及了光在投射到物体表面的时候究竟发生了什么。</p>
<p>我们来认识一个比较简单的经验模型，也就是Blinn-Phong着色模型，这个模型认为物体表面反射到相机的光线存在四种类型。</p>
<p>分别是自发光(emission)，环境光(ambient)，漫反射(diffuse)和高光反射(specular)。</p>
<p>先来写一下fragment shader的结构：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">fragmentShaderPayload</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">fragmentShaderPayload</span>() = <span class="keyword">default</span>;</span><br><span class="line">	<span class="built_in">fragmentShaderPayload</span>(<span class="type">const</span> Vertex&amp; vertex, <span class="type">const</span> PointLight&amp; light)</span><br><span class="line">		:<span class="built_in">vertex</span>(vertex), <span class="built_in">light</span>(light) &#123;&#125;</span><br><span class="line">	Vertex vertex;</span><br><span class="line">	PointLight light;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> Vertex <span class="title">BlinnPhongShader</span><span class="params">(<span class="type">const</span> fragmentShaderPayload&amp; payload)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">       <span class="comment">//emission</span></span><br><span class="line">       </span><br><span class="line">	<span class="comment">//ambient</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//diffuse</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//specular</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">auto</span> color = emission + ambient + diffuse + specular;</span><br><span class="line"></span><br><span class="line">	color = color * <span class="number">255.0f</span>;</span><br><span class="line"></span><br><span class="line">	color.x = color.x &gt; <span class="number">255.0f</span> ? <span class="number">255.0f</span> : color.x;</span><br><span class="line">	color.y = color.y &gt; <span class="number">255.0f</span> ? <span class="number">255.0f</span> : color.y;</span><br><span class="line">	color.z = color.z &gt; <span class="number">255.0f</span> ? <span class="number">255.0f</span> : color.z;</span><br><span class="line">	</span><br><span class="line">	Vertex v = payload.vertex;</span><br><span class="line">	v.vertexColor = <span class="built_in">TGAColor</span>(color.x, color.y, color.z);</span><br><span class="line">	<span class="keyword">return</span> v;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意一下我们的颜色使用uint_8存储的，也就是范围在0-255之间，如果计算结果大于255溢出，也就是说过曝光的话会重新从0开始计数，我们暂时处理不了过曝光，所以先把输出的颜色三个分量限制在255以内。但是我们做着色计算的时候需要将颜色映射到0-1范围内，大多数公式都是基于颜色用0-1的浮点数表示的基础来进行计算的。</p>
<h4 id="自发光">自发光</h4>
<p>自发光其实就是直接将着色点试做一个光源。</p>
<p>我们定义ke为发出的光的颜色，或者说是自发光系数，定义Ie为发出的光的intensity。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">myEigen::Vector3f <span class="title">ke</span><span class="params">(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span></span>;</span><br><span class="line"><span class="type">float</span> Ie = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//emission</span></span><br><span class="line"><span class="keyword">auto</span> emission = ke * Ie;</span><br></pre></td></tr></table></figure>
<p>我们不打算让模型自发光，所以都设置为0。</p>
<h4 id="环境光">环境光</h4>
<p>环境光类似于无差别地给模型上一组颜色，用来模拟一种间接光照的效果。实际在现实中的物体在面对单光源的时候不会因为哪个面背向光源就完全不可见，背向光源的表面也会被光线投射在其他表面上反射出来的光线给照亮，这就是我们说的间接光照。</p>
<p>我们定义一个三维颜色向量ka为环境光系数，再定义一个Ia为环境光的intensity，我们认为环境光就是ka*Ia。</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mover accent="true"><mrow><mi>a</mi><mi>m</mi><mi>b</mi><mi>i</mi><mi>e</mi><mi>n</mi><mi>t</mi></mrow><mo>⃗</mo></mover><mo>=</mo><mover accent="true"><mrow><mi>k</mi><mi>a</mi></mrow><mo>⃗</mo></mover><mo>∗</mo><mi>I</mi><mi>a</mi></mrow><annotation encoding="application/x-tex">\vec{ambient}=\vec{ka}*Ia
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9774em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9774em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">ambi</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span></span></span><span style="top:-3.2634em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2355em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9774em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9774em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">ka</span></span></span><span style="top:-3.2634em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2355em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mord mathnormal">a</span></span></span></span></span></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">myEigen::Vector3f <span class="title">ka</span><span class="params">(<span class="number">0.005</span>, <span class="number">0.005</span>, <span class="number">0.005</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ambient</span></span><br><span class="line"><span class="keyword">auto</span> ambient = ka * <span class="number">50</span>;</span><br></pre></td></tr></table></figure>
<h4 id="漫反射">漫反射</h4>
<p>漫反射是粗糙表面的反射，Blinn-Phong模型认为漫反射即粗糙表面在接收到光线后均匀地反射，也就是定义一个三维颜色向量kd为漫反射系数，直接乘以着色点接收到的irradiance就可以得到着色结果。kd一般来说就是我们看到的粗糙表面的颜色rgb值。</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mover accent="true"><mrow><mi>d</mi><mi>i</mi><mi>f</mi><mi>f</mi><mi>u</mi><mi>s</mi><mi>e</mi></mrow><mo>⃗</mo></mover><mo>=</mo><mover accent="true"><mrow><mi>k</mi><mi>d</mi></mrow><mo>⃗</mo></mover><mo>∗</mo><mi>i</mi><mi>r</mi><mi>r</mi><mi>a</mi><mi>d</mi><mi>i</mi><mi>a</mi><mi>n</mi><mi>c</mi><mi>e</mi><mo>=</mo><mover accent="true"><mrow><mi>k</mi><mi>d</mi></mrow><mo>⃗</mo></mover><mo>∗</mo><mfrac><mrow><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>n</mi><mi>s</mi><mi>i</mi><mi>t</mi><mi>y</mi><mo>∗</mo><mi>c</mi><mi>o</mi><mi>s</mi><mi>θ</mi></mrow><msup><mi>r</mi><mn>2</mn></msup></mfrac></mrow><annotation encoding="application/x-tex">\vec{diffuse}=\vec{kd}*irradiance=\vec{kd}*\frac{intensity*cos\theta}{r^2}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1719em;vertical-align:-0.1944em;"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9774em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.10764em;">ff</span><span class="mord mathnormal">u</span><span class="mord mathnormal">se</span></span></span><span style="top:-3.2634em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2355em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z'/></svg></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9774em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9774em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">d</span></span></span><span style="top:-3.2634em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2355em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.02778em;">rr</span><span class="mord mathnormal">a</span><span class="mord mathnormal">d</span><span class="mord mathnormal">ian</span><span class="mord mathnormal">ce</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9774em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9774em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">d</span></span></span><span style="top:-3.2634em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2355em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:2.0574em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">cos</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">myEigen::Vector3f <span class="title">kd</span><span class="params">(payload.vertex.vertexColor.bgra[<span class="number">2</span>] / <span class="number">255.0f</span>, payload.vertex.vertexColor.bgra[<span class="number">1</span>] / <span class="number">255.0f</span>, payload.vertex.vertexColor.bgra[<span class="number">0</span>] / <span class="number">255.0f</span>)</span></span>;	</span><br><span class="line"></span><br><span class="line"><span class="comment">//diffuse</span></span><br><span class="line"><span class="keyword">auto</span> pos = myEigen::<span class="built_in">Vector3f</span>(payload.vertex.vertex.x, payload.vertex.vertex.y, payload.vertex.vertex.z);</span><br><span class="line"><span class="keyword">auto</span> normal = myEigen::<span class="built_in">Vector3f</span>(payload.vertex.normal.x, payload.vertex.normal.y, payload.vertex.normal.z).<span class="built_in">Normalize</span>();</span><br><span class="line"><span class="keyword">auto</span> lightdir = (pos - payload.light.position).<span class="built_in">Normalize</span>();</span><br><span class="line"><span class="keyword">auto</span> r_2 = (pos - payload.light.position).<span class="built_in">Norm</span>();</span><br><span class="line"><span class="keyword">auto</span> diffuse = kd * std::<span class="built_in">max</span>(<span class="number">0.0f</span>, myEigen::<span class="built_in">dotProduct</span>(normal, lightdir)) * payload.light.intensity</span><br><span class="line">	/ r_2;</span><br></pre></td></tr></table></figure>
<h4 id="高光反射">高光反射</h4>
<p>高光反射用于模拟光滑表面上的反射，Blinn-Phong模型认为高光反射与我们眼睛观察角度、着色点表面法线和光照角度有关，因为镜面反射入射角等于出射角，可想而知如果观察角度刚好处于出射角那么接收到的光线会明显更多。</p>
<p>Blinn-Phong模型给出了如下公式：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mover accent="true"><mi>h</mi><mo>⃗</mo></mover><mo>=</mo><mfrac><mrow><mover accent="true"><mrow><mi>l</mi><mi>i</mi><mi>g</mi><mi>h</mi><mi>t</mi><mi>d</mi><mi>i</mi><mi>r</mi></mrow><mo>⃗</mo></mover><mo>+</mo><mover accent="true"><mrow><mi>e</mi><mi>y</mi><mi>e</mi><mi>d</mi><mi>i</mi><mi>r</mi></mrow><mo>⃗</mo></mover></mrow><mrow><mi mathvariant="normal">∣</mi><mover accent="true"><mrow><mi>l</mi><mi>i</mi><mi>g</mi><mi>h</mi><mi>t</mi><mi>d</mi><mi>i</mi><mi>r</mi></mrow><mo>⃗</mo></mover><mo>+</mo><mover accent="true"><mrow><mi>e</mi><mi>y</mi><mi>e</mi><mi>d</mi><mi>i</mi><mi>r</mi></mrow><mo>⃗</mo></mover><mi mathvariant="normal">∣</mi></mrow></mfrac><mspace linebreak="newline"></mspace><mover accent="true"><mrow><mi>s</mi><mi>p</mi><mi>e</mi><mi>c</mi><mi>u</mi><mi>l</mi><mi>a</mi><mi>r</mi></mrow><mo>⃗</mo></mover><mo>=</mo><mover accent="true"><mrow><mi>k</mi><mi>s</mi></mrow><mo>⃗</mo></mover><mo>∗</mo><mo stretchy="false">(</mo><mover accent="true"><mi>h</mi><mo>⃗</mo></mover><mo>∗</mo><mover accent="true"><mrow><mi>n</mi><mi>o</mi><mi>r</mi><mi>m</mi><mi>a</mi><mi>l</mi></mrow><mo>⃗</mo></mover><msup><mo stretchy="false">)</mo><mrow><mi>N</mi><mi>s</mi></mrow></msup><mo>∗</mo><mfrac><mrow><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>n</mi><mi>s</mi><mi>i</mi><mi>t</mi><mi>y</mi><mo>∗</mo><mi>c</mi><mi>o</mi><mi>s</mi><mi>θ</mi></mrow><msup><mi>r</mi><mn>2</mn></msup></mfrac></mrow><annotation encoding="application/x-tex">\vec{h}=\frac{\vec{lightdir}+\vec{eyedir}}{|\vec{lightdir}+\vec{eyedir}|}\\
\vec{specular}=\vec{ks}*(\vec{h}*\vec{normal})^{Ns}*\frac{intensity*cos\theta}{r^2}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9774em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9774em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal">h</span></span><span style="top:-3.2634em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2355em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.7719em;vertical-align:-1.1174em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6544em;"><span style="top:-2.1326em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">∣</span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9774em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">h</span><span class="mord mathnormal">t</span><span class="mord mathnormal">d</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span><span style="top:-3.2634em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2355em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z'/></svg></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9774em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">eye</span><span class="mord mathnormal">d</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span><span style="top:-3.2634em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2355em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z'/></svg></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span></span></span></span></span></span><span class="mord">∣</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9774em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">h</span><span class="mord mathnormal">t</span><span class="mord mathnormal">d</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span><span style="top:-3.2634em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2355em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z'/></svg></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9774em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">eye</span><span class="mord mathnormal">d</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span><span style="top:-3.2634em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2355em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z'/></svg></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.1174em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1.1719em;vertical-align:-0.1944em;"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9774em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="mord mathnormal">p</span><span class="mord mathnormal">ec</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span><span style="top:-3.2634em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2355em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z'/></svg></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9774em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9774em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">s</span></span></span><span style="top:-3.2634em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2355em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.2274em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9774em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal">h</span></span><span style="top:-3.2634em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2355em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.2274em;vertical-align:-0.25em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9774em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.02778em;">or</span><span class="mord mathnormal">ma</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span></span></span><span style="top:-3.2634em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2355em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span><span class="mord mathnormal mtight">s</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:2.0574em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">cos</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>除去经验公式特有的系数ks外，高光反射与漫反射不同的地方就是多乘了一个观察角度与光照角度的半程向量和着色点法线的余弦值的Ns次方，这个Ns用来控制高光范围，Ns越大高光范围越小。</p>
<p>值得一提的是，Blinn-Phong模型其实是改进自另一经典模型Phong模型的结果，在Phong模型中半程向量和法线的余弦值被替换成观察角度和光照角度的余弦值，这显然是没有Blinn-Phong模型模拟地更准确的。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">myEigen::Vector3f <span class="title">ks</span><span class="params">(<span class="number">0.7937</span>, <span class="number">0.7937</span>, <span class="number">0.7937</span>)</span></span>;</span><br><span class="line"><span class="comment">//specular</span></span><br><span class="line"><span class="keyword">auto</span> viewdir = (-pos).<span class="built_in">Normalize</span>();</span><br><span class="line"><span class="keyword">auto</span> h = (viewdir + lightdir).<span class="built_in">Normalize</span>();</span><br><span class="line"><span class="keyword">auto</span> specular = ks * payload.light.intensity * std::<span class="built_in">pow</span>(std::<span class="built_in">max</span>(<span class="number">0.0f</span>, myEigen::<span class="built_in">dotProduct</span>(h, normal)),<span class="number">20.0f</span>)</span><br><span class="line">	/ r_2;</span><br></pre></td></tr></table></figure>
<p>注意一下我们填入的一些常量数值，这些数值需要尽量调试到一个合理的范围内，避免出现曝光过度或者环境光太亮的结果。</p>
<h4 id="着色结果">着色结果</h4>
<p>其实真要是认真看了上面内容的同学应该已经一头雾水了，怎么第一阶段还有模有样地在那儿计算能量和irradiance，第二阶段就啥也不管硬套系数了。</p>
<p>这就是经验模型的缺点，第二阶段的计算完全没有与能量有关的计算，更多的是从经验出发拟合出的一个简单模型，让我们看看这个经验模型的结果。</p>
<p><img src="https://raw.githubusercontent.com/chiuhoukazusa/blog_img/main/202301180450909.gif" alt="BlinnPhong"></p>
<p>模型来自于Fromsoftware的游戏EldenRing的角色Melina，仅作学习用途！</p>
<p>效果其实还不错，虽然肯定是不符合物理规律的，但是看起来还挺准确。</p>
<h2 id="MTL文件格式">MTL文件格式</h2>
<p>我们之前已经看过了202酱的MTL文件，但是202酱只使用了一张漫反射纹理，我们需要有更全面的MTL文件。</p>
<p>梅琳娜的模型文件来自于法环的游戏解包，我看MMD区都在用，我拿来用一用应该也没事，源文件为FBX格式，我使用了blender导出为obj-mtl格式，并且顺带把所有png纹理改成了tga纹理。</p>
<p>我们将以梅梅的MTL文件中的其中一个材质定义来看看MTL文件是怎么关联纹理和材质的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">newmtl 40_+cape_0.1_0_0</span><br><span class="line">Ns 96.078415</span><br><span class="line">Ka 1.000000 1.000000 1.000000</span><br><span class="line">Ke 0.000000 0.000000 0.000000</span><br><span class="line">Ni 1.450000</span><br><span class="line">d 0.000000</span><br><span class="line">illum 1</span><br><span class="line">map_Kd Melina_Cloth_D(Baked).tga</span><br><span class="line">map_Ks Melina_Cloth_S.tga</span><br><span class="line">map_Bump -bm 1.000000 Melina_Cloth_N(Baked).tga</span><br></pre></td></tr></table></figure>
<p>可以看到上镜的很多都是老朋友，Ns，Ka，Ke，Kd，Ks都在我们之前的公式上出现过，也就是我们的fragment payload中将会加入一个material类绑定上这个片元应该对应的这些Ka，Kd等数据，然后直接在shader中使用这些现成数据即可。至于没出现过的量，Ni为光密度，用于计算折射的时候使用，因为我们的光照模型没有折射，我们也暂时不考虑透明物体的渲染，我们暂时不考虑。同样的，d指dissolve，指的是当前材质溶解于背景的程度，我们也暂时不考虑。</p>
<p>然后是重量级的illum关键字，illum后跟着的数字为0到10中的一个整数，每个整数代表了一种光照模型，具体可以根据这个博客中的讲解来看。</p>
<p><a target="_blank" rel="noopener" href="http://www.paulbourke.net/dataformats/mtl/">http://www.paulbourke.net/dataformats/mtl/</a></p>
<p>中文论坛上的关于mtl文件的解析都是直接搬的这篇文章，但是就搬了前面的部分，后面对光照模型的解析完全没搬。。。大家可以直接翻到这篇文章的最后一部分看下光照模型的详细解析。</p>
<p>我这里就搬几个常见的，illum 0对应的是一个只有颜色光照模型，输出颜色公式是color = Kd，不进行任何光照计算。</p>
<p>illum 2对应的就是我们之前写的Blinn-Phong着色模型，而illum 1对应的则是除去了高光的Blinn-Phong模型，只计算环境光和漫反射项。</p>
<p>剩下的几种暂时用不到就先不提了，可以看看文章里怎么写的。</p>
<p>我们可以看到有些变量使用了map前缀，这意味着这个变量的值取自一张纹理贴图的rgb值，每一个顶点都有一个纹理坐标，又称uv，每张纹理我们都会以左下角为原点，建立一个直角坐标系，两个坐标轴分别为u和v，每张纹理的uv坐标范围为[0, 1]，每当我们需要从纹理中读取rgb值的时候都会以这个顶点对应的uv坐标为标准去查询，而uv是一个二维向量，我们只需像法线、顶点颜色那样当成一个顶点的属性即可，我们的所有线性插值和重心坐标插值以及透视矫正都已经在上一节写好了，我们只需要将texcoord也就是uv加进Vertex类就行。</p>
<h2 id="纹理映射">纹理映射</h2>
<h3 id="读取MTL文件">读取MTL文件</h3>
<p>MTL文件的读取我们放在material类的构造函数里：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;material.h&quot;</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;myEigen.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;tgaimage.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> rst</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">class</span> <span class="title class_">Material</span></span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">public</span>:</span><br><span class="line">		<span class="built_in">Material</span>() = <span class="keyword">default</span>;</span><br><span class="line">		<span class="built_in">Material</span>(<span class="type">const</span> std::string&amp; filename, <span class="type">const</span> std::string&amp; root, <span class="type">const</span> std::string&amp; materialName);</span><br><span class="line">	<span class="keyword">public</span>:</span><br><span class="line">		std::string name;</span><br><span class="line"></span><br><span class="line">		myEigen::Vector3f Ke;</span><br><span class="line">		myEigen::Vector3f Kd;</span><br><span class="line">		myEigen::Vector3f Ka;</span><br><span class="line">		myEigen::Vector3f Ks;</span><br><span class="line">		<span class="type">float</span> illum;</span><br><span class="line">		<span class="type">float</span> Ns;</span><br><span class="line">		<span class="type">float</span> d;</span><br><span class="line">		<span class="type">float</span> Ni;</span><br><span class="line"></span><br><span class="line">		TGAImage map_Ke;</span><br><span class="line">		TGAImage map_Kd;</span><br><span class="line">		TGAImage map_Ka;</span><br><span class="line">		TGAImage map_Ks;</span><br><span class="line">		TGAImage map_Ns;</span><br><span class="line">		TGAImage map_d;</span><br><span class="line"></span><br><span class="line">		<span class="type">float</span> Bump;</span><br><span class="line">		TGAImage map_Bump;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;material.cpp&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;material.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> rst</span><br><span class="line">&#123;</span><br><span class="line">	Material::<span class="built_in">Material</span>(<span class="type">const</span> std::string&amp; filename, <span class="type">const</span> std::string&amp; root, <span class="type">const</span> std::string&amp; materialName)</span><br><span class="line">	&#123;</span><br><span class="line">		name = materialName;</span><br><span class="line"></span><br><span class="line">		std::ifstream mtl;</span><br><span class="line">		mtl.<span class="built_in">open</span>(root + filename, std::ifstream::in);</span><br><span class="line">		<span class="keyword">if</span> (mtl.<span class="built_in">fail</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			std::cerr &lt;&lt; <span class="string">&quot;Cannot open:&quot;</span> &lt;&lt; filename &lt;&lt; std::endl;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		std::string mtlLine;</span><br><span class="line">		std::vector&lt;std::string&gt; mtlDescribe;</span><br><span class="line">		<span class="type">bool</span> isWrite = <span class="literal">false</span>;</span><br><span class="line">		<span class="keyword">while</span> (!mtl.<span class="built_in">eof</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			std::<span class="built_in">getline</span>(mtl, mtlLine);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (mtlLine.<span class="built_in">compare</span>(<span class="number">0</span>, <span class="number">7</span>, <span class="string">&quot;newmtl &quot;</span>) == <span class="number">0</span>)</span><br><span class="line">				<span class="keyword">if</span> (mtlLine.<span class="built_in">compare</span>(<span class="number">7</span>, materialName.<span class="built_in">size</span>(), materialName) == <span class="number">0</span>)</span><br><span class="line">					isWrite = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span>(isWrite)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span> (mtlLine.<span class="built_in">size</span>() == <span class="number">0</span>) <span class="keyword">break</span>;</span><br><span class="line">				mtlDescribe.<span class="built_in">push_back</span>(mtlLine);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">auto</span>&amp; s : mtlDescribe)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="function">std::istringstream <span class="title">iss</span><span class="params">(s)</span></span>;</span><br><span class="line">			std::string header;</span><br><span class="line">			<span class="type">char</span> trash;</span><br><span class="line">			<span class="keyword">if</span> (s.<span class="built_in">compare</span>(<span class="number">0</span>, <span class="number">3</span>, <span class="string">&quot;Ns &quot;</span>) == <span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				iss &gt;&gt; header;</span><br><span class="line">				iss &gt;&gt; Ns;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (s.<span class="built_in">compare</span>(<span class="number">0</span>, <span class="number">3</span>, <span class="string">&quot;Ke &quot;</span>) == <span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				iss &gt;&gt; header;</span><br><span class="line">				iss &gt;&gt; Ke.x &gt;&gt; Ke.y &gt;&gt; Ke.z;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (s.<span class="built_in">compare</span>(<span class="number">0</span>, <span class="number">3</span>, <span class="string">&quot;Ka &quot;</span>) == <span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				iss &gt;&gt; header;</span><br><span class="line">				iss &gt;&gt; Ka.x &gt;&gt; Ka.y &gt;&gt; Ka.z;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (s.<span class="built_in">compare</span>(<span class="number">0</span>, <span class="number">3</span>, <span class="string">&quot;Kd &quot;</span>) == <span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				iss &gt;&gt; header;</span><br><span class="line">				iss &gt;&gt; Kd.x &gt;&gt; Kd.y &gt;&gt; Kd.z;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (s.<span class="built_in">compare</span>(<span class="number">0</span>, <span class="number">3</span>, <span class="string">&quot;Ks &quot;</span>) == <span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				iss &gt;&gt; header;</span><br><span class="line">				iss &gt;&gt; Ks.x &gt;&gt; Ks.y &gt;&gt; Ks.z;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (s.<span class="built_in">compare</span>(<span class="number">0</span>, <span class="number">2</span>, <span class="string">&quot;d &quot;</span>) == <span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				iss &gt;&gt; header;</span><br><span class="line">				iss &gt;&gt; d;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (s.<span class="built_in">compare</span>(<span class="number">0</span>, <span class="number">3</span>, <span class="string">&quot;Ni &quot;</span>) == <span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				iss &gt;&gt; header;</span><br><span class="line">				iss &gt;&gt; Ni;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (s.<span class="built_in">compare</span>(<span class="number">0</span>, <span class="number">6</span>, <span class="string">&quot;illum &quot;</span>) == <span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				iss &gt;&gt; header;</span><br><span class="line">				iss &gt;&gt; illum;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (s.<span class="built_in">compare</span>(<span class="number">0</span>, <span class="number">7</span>, <span class="string">&quot;map_Ke &quot;</span>) == <span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				std::string textureName;</span><br><span class="line">				iss &gt;&gt; header;</span><br><span class="line">				iss &gt;&gt; textureName;</span><br><span class="line">				map_Ke = <span class="built_in">TGAImage</span>();</span><br><span class="line">				map_Ke.<span class="built_in">read_tga_file</span>(root + textureName);</span><br><span class="line">				map_Ke.<span class="built_in">flip_vertically</span>();</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (s.<span class="built_in">compare</span>(<span class="number">0</span>, <span class="number">7</span>, <span class="string">&quot;map_Ka &quot;</span>) == <span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				std::string textureName;</span><br><span class="line">				iss &gt;&gt; header;</span><br><span class="line">				iss &gt;&gt; textureName;</span><br><span class="line">				map_Ka = <span class="built_in">TGAImage</span>();</span><br><span class="line">				map_Ka.<span class="built_in">read_tga_file</span>(root + textureName);</span><br><span class="line">				map_Ka.<span class="built_in">flip_vertically</span>();</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (s.<span class="built_in">compare</span>(<span class="number">0</span>, <span class="number">7</span>, <span class="string">&quot;map_Kd &quot;</span>) == <span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				std::string textureName;</span><br><span class="line">				iss &gt;&gt; header;</span><br><span class="line">				iss &gt;&gt; textureName;</span><br><span class="line">				map_Kd = <span class="built_in">TGAImage</span>();</span><br><span class="line">				map_Kd.<span class="built_in">read_tga_file</span>(root + textureName);</span><br><span class="line">				map_Kd.<span class="built_in">flip_vertically</span>();</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (s.<span class="built_in">compare</span>(<span class="number">0</span>, <span class="number">7</span>, <span class="string">&quot;map_Ks &quot;</span>) == <span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				std::string textureName;</span><br><span class="line">				iss &gt;&gt; header;</span><br><span class="line">				iss &gt;&gt; textureName;</span><br><span class="line">				map_Ks = <span class="built_in">TGAImage</span>();</span><br><span class="line">				map_Ks.<span class="built_in">read_tga_file</span>(root + textureName);</span><br><span class="line">				map_Ks.<span class="built_in">flip_vertically</span>();</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (s.<span class="built_in">compare</span>(<span class="number">0</span>, <span class="number">7</span>, <span class="string">&quot;map_Ns &quot;</span>) == <span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				std::string textureName;</span><br><span class="line">				iss &gt;&gt; header;</span><br><span class="line">				iss &gt;&gt; textureName;</span><br><span class="line">				map_Ns = <span class="built_in">TGAImage</span>();</span><br><span class="line">				map_Ns.<span class="built_in">read_tga_file</span>(root + textureName);</span><br><span class="line">				map_Ns.<span class="built_in">flip_vertically</span>();</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (s.<span class="built_in">compare</span>(<span class="number">0</span>, <span class="number">6</span>, <span class="string">&quot;map_d &quot;</span>) == <span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				std::string textureName;</span><br><span class="line">				iss &gt;&gt; header;</span><br><span class="line">				iss &gt;&gt; textureName;</span><br><span class="line">				map_d = <span class="built_in">TGAImage</span>();</span><br><span class="line">				map_d.<span class="built_in">read_tga_file</span>(root + textureName);</span><br><span class="line">				map_d.<span class="built_in">flip_vertically</span>();</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (s.<span class="built_in">compare</span>(<span class="number">0</span>, <span class="number">9</span>, <span class="string">&quot;map_Bump &quot;</span>) == <span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				std::string textureName;</span><br><span class="line">				iss &gt;&gt; header &gt;&gt; header &gt;&gt; Bump;</span><br><span class="line">				iss &gt;&gt; textureName;</span><br><span class="line">				map_Bump = <span class="built_in">TGAImage</span>();</span><br><span class="line">				map_Bump.<span class="built_in">read_tga_file</span>(root + textureName);</span><br><span class="line">				map_Bump.<span class="built_in">flip_vertically</span>();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到我们每次读取纹理文件的时候都会水平翻转图像，这是因为我在之前测试的时候怎么也写不对纹理映射，后来我把纹理读了再原封不动输出才发现tgaimage.cpp读取的纹理文件竟然是水平翻转的，具体原因我暂时也没排查出为什么，我猜测也许是tga文件头里的imagedescriptor的读取出了问题？但是使用blender是可以正常打开并且渲染正确的，我觉得也许是代码的问题。但是anyway，我们就先这样翻转着吧，纹理映射的重点还在后头，就是翻转函数的开销其实比较大，给我们的纹理和模型读取陡增了一些计算时间。</p>
<h3 id="双线性插值">双线性插值</h3>
<p>接下来我们有了material，将它传到fragmentpayload里就可以在shader里读取相关信息了。</p>
<p>但是对于使用纹理存储的变量信息，我们需要根据uv坐标从图上读取出来。</p>
<p>听起来很简单，tga解析器为我们提供了set和get的方法，直接get不就行了？</p>
<p>但是我们的uv坐标在乘以tga的长宽之后显然都是打乱的，几乎不可能恰好取在像素中心，那对于这些采样点我们怎么找他的对应颜色呢？我们当然可以直接找到离采样点最近的像素中心坐标，返回这个像素的rgb值，这种方法被称作nearest，取最近点。</p>
<p>但我们有更准确且比较清晰的办法，那就是双线性插值。</p>
<p>我们之前的线性插值都是一维的两个点，但在纹理这种二维平面上可不使用，可以看这个示意图：</p>
<p><img src="https://raw.githubusercontent.com/chiuhoukazusa/blog_img/main/202301180450986.png" alt="BilinearInterpolation"></p>
<p>这张图很显然来自games101闫令琪老师的课件。</p>
<p>图里写的非常明白，还附上了伪代码，可以看出就是做三次插值，水平方向两次竖直方向一次，当然反过来应该也是没问题的。</p>
<p>需要时刻注意像素中心坐标不是整数而是x.5的小数。</p>
<p>同时除了插值以外还有一件比较重要的事，就是纹理环绕方式。</p>
<p>uv坐标虽然我们都是基于[0, 1]范围内讨论的，但有时候我们会用到超出这个范围的uv坐标，这时候我们怎么处理这些超范围的坐标？</p>
<p>当然也是有多种方法，大部分情况下默认repeat，就是大于1就再从0开始递增，相当于纹理在边缘处重复，这有点像桌面壁纸平铺的表现形式。</p>
<p>也有其他的情况，比如超出范围就重复边缘处的像素颜色，或者干脆超出范围就不画了，也是可以的，但是最广泛的还是repeat的形式。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">inline</span> TGAColor <span class="title">bilinearInterpolate</span><span class="params">(<span class="type">const</span> TGAImage&amp; texture, <span class="type">float</span> u, <span class="type">float</span> v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//return texture.get(u, v);</span></span><br><span class="line">	<span class="keyword">while</span> (u &gt; texture.<span class="built_in">width</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		u -= texture.<span class="built_in">width</span>();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">while</span> (v &gt; texture.<span class="built_in">height</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		v -= texture.<span class="built_in">height</span>();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">while</span> (u &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		u += texture.<span class="built_in">width</span>();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">while</span> (v &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		v += texture.<span class="built_in">height</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="type">float</span> uu = u - <span class="number">0.5f</span>;</span><br><span class="line">	<span class="type">float</span> vv = v - <span class="number">0.5f</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">auto</span> c_u1 = myEigen::<span class="built_in">Vector2f</span>(<span class="built_in">ceil</span>(uu), <span class="built_in">floor</span>(vv));</span><br><span class="line">	<span class="keyword">auto</span> f_u1 = myEigen::<span class="built_in">Vector2f</span>(<span class="built_in">floor</span>(uu), <span class="built_in">floor</span>(vv));</span><br><span class="line"></span><br><span class="line">	TGAColor u_interpolated1 = <span class="built_in">ColorLerp</span>(texture.<span class="built_in">get</span>(f_u1.x, f_u1.y), texture.<span class="built_in">get</span>(c_u1.x, c_u1.y), uu - <span class="built_in">floor</span>(uu));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">auto</span> c_u2 = myEigen::<span class="built_in">Vector2f</span>(<span class="built_in">ceil</span>(uu), <span class="built_in">ceil</span>(vv));</span><br><span class="line">	<span class="keyword">auto</span> f_u2 = myEigen::<span class="built_in">Vector2f</span>(<span class="built_in">floor</span>(uu), <span class="built_in">ceil</span>(vv));</span><br><span class="line"></span><br><span class="line">	TGAColor u_interpolated2 = <span class="built_in">ColorLerp</span>(texture.<span class="built_in">get</span>(f_u2.x, f_u2.y), texture.<span class="built_in">get</span>(c_u2.x, c_u2.y), uu - <span class="built_in">floor</span>(uu));</span><br><span class="line"></span><br><span class="line">	TGAColor out = <span class="built_in">ColorLerp</span>(u_interpolated2, u_interpolated1, vv - <span class="built_in">floor</span>(vv));</span><br><span class="line">	<span class="keyword">return</span> out;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>至于调用这个函数的代码有点过于冗长了，我就不放在这里了，感兴趣的可以直接从我的代码仓库里查看。</p>
<p>我们看一下渲染效果：</p>
<p><img src="https://raw.githubusercontent.com/chiuhoukazusa/blog_img/main/202301180450077.gif" alt="双线性插值"></p>
<p>其实到现在debug模式已经有点吃力了，渲染72帧起码180秒往上，其实占用开销大头的还是纹理读取，我现在都快常驻release模式了，这72帧在release模式下算上模型和纹理加载也就30秒上下，我开的是-O2优化。</p>
<p>有个值得一提的事，那就是我发现mtl文件里梅梅的大部分光照模型都是illum 1，也就是不考虑高光反射，但是所有梅梅模型的所有部分都配了高光反射纹理，也就是map_Ks。</p>
<p>这显然是不合理的，问题应该出在fbx和obj-mtl格式的转换上，所以我擅做主张把梅梅的mtl文件里的illum 1全部改成了illum 2。</p>
<p>看看效果：</p>
<p><img src="https://raw.githubusercontent.com/chiuhoukazusa/blog_img/main/202301180450171.gif" alt="高光贴图"></p>
<p>可以看到最明显的应该是靴子上的高光。</p>
<h3 id="法线贴图">法线贴图</h3>
<p>说了这么多，其实mtl文件里有一项一直没被我们用到，那就是map_Bump。</p>
<p>我们之前说不管是纹理贴图还是直接写在mtl文件里，都是为了用存储在外部的数据来替换我们公式里的一些变量，自然而然的，表面法线作为一个重要变量显然也可以被替换。</p>
<p>怎么通过一张图来记录表面法线的信息，这不是一个简单的话题。</p>
<h4 id="凹凸贴图">凹凸贴图</h4>
<p>比较原始的一种方案称作凹凸贴图，用一张灰度图来记录高度信息，越亮的像素越“高”，或者说越凸。</p>
<p>这种方法现在用的比较少了，games101中一开始讲的也是凹凸贴图的原理，可以去看视频里怎么说的。</p>
<h4 id="法线贴图-2">法线贴图</h4>
<p>我们的重点还是法线贴图。因为法线在经过标准化后，xyz三个分量基本上就在-1到1的区间内，所以可以很简单地映射到0到255的颜色信息上表示。</p>
<p>说到这里最容易想到的就是直接跟漫反射贴图啥的一样，给每一个uv对应一个颜色存储法线信息，使用的时候直接采样出来直接替换。</p>
<p>这种方式准确的说叫做世界空间法线贴图。以下是一张世界空间法线贴图的例子。</p>
<p><img src="https://raw.githubusercontent.com/chiuhoukazusa/blog_img/main/202301180450282.png" alt="diablo3_pose_nm"></p>
<p>这张贴图来自于tinyrenderer的迪亚波罗的世界空间法线贴图。可以看到比较五颜六色，使用的时候很方便直接采样就可以。</p>
<p>但是如果我们需要人物做一些动作呢，人物一旦做了一些动作之后，这个法线贴图似乎就不怎么起效了，因为这里的法线指向都是写死的，假设人物只是把手掌翻了一个面，我们的法线读取都会出现问题。</p>
<p>所以我们更多使用的是切线空间法线贴图，以下是另一个例子：</p>
<p><img src="https://raw.githubusercontent.com/chiuhoukazusa/blog_img/main/202301180450379.png" alt="diablo3_pose_nm_tangent"></p>
<p>这个是切线空间法线贴图，这里存储的信息跟上一张贴图是一模一样的，也是来自tinyrenderer的贴图。</p>
<p>简单来说，就是我们在模型的每个表面构建TBN三个向量作为切线空间的三个基向量。这三个向量分别为Tangent, Bitangent, normal三个向量，所以简写为TBN。</p>
<p>其中，T和B向量分别指向模型u和v在三维空间中延伸的方向，这样说可能比较抽象，需要想象一下。每个模型表面上的点都会有他专属的uv坐标，我们聚焦到模型表面的一个最简单的三角面，就像下面这张图，我们图里画的红线和蓝线就是u和v两个量在三维空间中的“<strong>等势面</strong>”。</p>
<p><img src="https://raw.githubusercontent.com/chiuhoukazusa/blog_img/main/202301180450484.png" alt="grid_texture"></p>
<p>而N向量就是每个顶点原本的法线，由此我们构建出了一个局部坐标系，我们在切线空间法线贴图中采样到的值就是基于这个局部坐标系的。</p>
<p><strong>（实际上我说的也不是完全准确。我们规定N向量必须与T和B向量垂直。很显然对于如图所示的扁平的三角形面内，TB看似应该是两个固定的向量，然而因为三角形内的每个顶点对应的法线并不一样，我们构建TBN空间需要明确N与TB垂直，所以实际上对于每个顶点，我们都需要根据每个顶点所拥有的具体的法线值来将这个三角形内的T和B向量稍稍旋转一下来做到跟N向量垂直。这个矛盾主要是因为虽然我们用三角形来模拟物体表面，但是实际上我们做的顶点插值等工作超越了简单的三角形，做到了用三角形来模拟复杂表面的结果，所以我们不能再简单地将物体表面看做是三角形，也就是说我们要求的T和B向量并不是uv在三角形内延伸的方向，而是具体到每一个顶点上延伸的方向）</strong></p>
<p>所以我们在采样完了法线贴图中的值后，我们需要做的就是将这个法线从局部坐标系变换到模型坐标系，然后再替换掉原有的法线值，这样法线贴图才能正常运作。</p>
<p>这一整串步骤的难点就在于如何得到一个变换矩阵，用来将这个法线从切线空间转换为模型坐标系，这个变换矩阵我们一般也称作TBN矩阵。</p>
<p>我们之前讨论过坐标系变换矩阵怎么写，因为这里不涉及到位置的变换，所以只用一个3x3矩阵就可以做到，同时这个3x3矩阵第一列，第二列和第三列分别为TBN三个向量在模型空间中的值。</p>
<p>N向量就是原本的法线向量，这个不用管，重点在于T和B，我们该如何得到三维空间中u和v的延伸方向向量？</p>
<p>我们看上面的图可以想象，先只关注红线，也就是u的<strong>等势面</strong>，或者可以理解成<strong>等高线</strong>，我们真正想要求得的是u向量本身，也就是这个我们画出来的等高线的<strong>梯度</strong>（gradient），梯度有一个比较简单的求法，假设我们有一个线性函数。$$u=f(x, y, z)=Ax+By+Cz+D$$，这个线性函数的梯度就是(A, B, C)，也就是T向量就是(A, B, C)。同样我们也可以令v=f(x, y, z)，写出一个关于v的线性函数，对他求梯度就可以得到B向量了，最后的N向量就直接使用正交化后的顶点法线就可以了。</p>
<p>我们用以上思路来以p0, p1, p2三个顶点的数据为基础来求解一下T向量：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>u</mi><mn>0</mn></msub><mo>=</mo><mi>u</mi><mo stretchy="false">(</mo><msub><mi>p</mi><mn>0</mn></msub><mo stretchy="false">)</mo><mo>=</mo><mi>A</mi><msub><mi>x</mi><mn>0</mn></msub><mo>+</mo><mi>B</mi><msub><mi>y</mi><mn>0</mn></msub><mo>+</mo><mi>C</mi><msub><mi>z</mi><mn>0</mn></msub><mo>+</mo><mi>D</mi><mspace linebreak="newline"></mspace><msub><mi>u</mi><mn>1</mn></msub><mo>=</mo><mi>u</mi><mo stretchy="false">(</mo><msub><mi>p</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mo>=</mo><mi>A</mi><msub><mi>x</mi><mn>1</mn></msub><mo>+</mo><mi>B</mi><msub><mi>y</mi><mn>1</mn></msub><mo>+</mo><mi>C</mi><msub><mi>z</mi><mn>1</mn></msub><mo>+</mo><mi>D</mi><mspace linebreak="newline"></mspace><msub><mi>u</mi><mn>2</mn></msub><mo>=</mo><mi>u</mi><mo stretchy="false">(</mo><msub><mi>p</mi><mn>2</mn></msub><mo stretchy="false">)</mo><mo>=</mo><mi>A</mi><msub><mi>x</mi><mn>2</mn></msub><mo>+</mo><mi>B</mi><msub><mi>y</mi><mn>2</mn></msub><mo>+</mo><mi>C</mi><msub><mi>z</mi><mn>2</mn></msub><mo>+</mo><mi>D</mi><mspace linebreak="newline"></mspace><msub><mi>u</mi><mn>1</mn></msub><mo>−</mo><msub><mi>u</mi><mn>0</mn></msub><mo>=</mo><mi>A</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mn>1</mn></msub><mo>−</mo><msub><mi>x</mi><mn>0</mn></msub><mo stretchy="false">)</mo><mo>+</mo><mi>B</mi><mo stretchy="false">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>−</mo><msub><mi>y</mi><mn>0</mn></msub><mo stretchy="false">)</mo><mo>+</mo><mi>C</mi><mo stretchy="false">(</mo><msub><mi>z</mi><mn>1</mn></msub><mo>−</mo><msub><mi>z</mi><mn>0</mn></msub><mo stretchy="false">)</mo><mspace linebreak="newline"></mspace><msub><mi>u</mi><mn>2</mn></msub><mo>−</mo><msub><mi>u</mi><mn>0</mn></msub><mo>=</mo><mi>A</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mn>2</mn></msub><mo>−</mo><msub><mi>x</mi><mn>0</mn></msub><mo stretchy="false">)</mo><mo>+</mo><mi>B</mi><mo stretchy="false">(</mo><msub><mi>y</mi><mn>2</mn></msub><mo>−</mo><msub><mi>y</mi><mn>0</mn></msub><mo stretchy="false">)</mo><mo>+</mo><mi>C</mi><mo stretchy="false">(</mo><msub><mi>z</mi><mn>2</mn></msub><mo>−</mo><msub><mi>z</mi><mn>0</mn></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">u_0=u(p_0)=Ax_0+By_0+Cz_0+D\\
u_1=u(p_1)=Ax_1+By_1+Cz_1+D\\
u_2=u(p_2)=Ax_2+By_2+Cz_2+D\\
u_1-u_0=A(x_1-x_0)+B(y_1-y_0)+C(z_1-z_0)\\
u_2-u_0=A(x_2-x_0)+B(y_2-y_0)+C(z_2-z_0)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">u</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord mathnormal">A</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">u</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord mathnormal">A</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">u</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord mathnormal">A</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">A</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">A</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p>就只靠后面两个方程可求不出一个唯一解，我们还需要根据N和TB垂直来写出第三个方程组来计算出唯一解。</p>
<p><strong>（这里第三个方程组实际上就对应着我前面括号内所说的将三角形内看似固定的T和B向量“旋转”到合适位置的过程，如果这个三角形内的所有顶点的法线都相同，也就是使用面法线代替顶点法线，那么三角形内的T和B向量就真的是“固定”的向量了，但大多数时候我们用的插值得到的顶点法线，所以每个顶点对应的T和B向量各不相同）</strong></p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mn>0</mn><mo>=</mo><mo stretchy="false">(</mo><mi>A</mi><mo separator="true">,</mo><mi>B</mi><mo separator="true">,</mo><mi>C</mi><mo stretchy="false">)</mo><mo>⋅</mo><mover accent="true"><mi>N</mi><mo>⃗</mo></mover><mo>=</mo><mover accent="true"><mi>T</mi><mo>⃗</mo></mover><mo>⋅</mo><mover accent="true"><mi>N</mi><mo>⃗</mo></mover></mrow><annotation encoding="application/x-tex">0=(A,B,C)\cdot{\vec{N}}=\vec{T}\cdot{\vec{N}}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.9663em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9663em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span><span style="top:-3.2523em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.1522em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9663em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9663em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span><span style="top:-3.2523em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.1522em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.9663em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9663em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span><span style="top:-3.2523em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.1522em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>我们将上面两个方程也改写成向量点乘形式：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mover accent="true"><mi>T</mi><mo>⃗</mo></mover><mo>⋅</mo><mover accent="true"><mrow><msub><mi>p</mi><mn>1</mn></msub><msub><mi>p</mi><mn>0</mn></msub></mrow><mo>⃗</mo></mover><mo>=</mo><msub><mi>u</mi><mn>1</mn></msub><mo>−</mo><msub><mi>u</mi><mn>0</mn></msub><mspace linebreak="newline"></mspace><mover accent="true"><mi>T</mi><mo>⃗</mo></mover><mo>⋅</mo><mover accent="true"><mrow><msub><mi>p</mi><mn>2</mn></msub><msub><mi>p</mi><mn>0</mn></msub></mrow><mo>⃗</mo></mover><mo>=</mo><msub><mi>u</mi><mn>2</mn></msub><mo>−</mo><msub><mi>u</mi><mn>0</mn></msub><mspace linebreak="newline"></mspace><mover accent="true"><mi>T</mi><mo>⃗</mo></mover><mo>⋅</mo><mover accent="true"><mi>N</mi><mo>⃗</mo></mover><mo>=</mo><mn>0</mn><mspace linebreak="newline"></mspace></mrow><annotation encoding="application/x-tex">\vec{T}\cdot{\vec{p_1p_0}}=u_1-u_0\\
\vec{T}\cdot{\vec{p_2p_0}}=u_2-u_0\\
\vec{T}\cdot{\vec{N}}=0\\
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9663em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9663em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span><span style="top:-3.2523em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.1522em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.9084em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2355em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z'/></svg></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.9663em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9663em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span><span style="top:-3.2523em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.1522em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.9084em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2355em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z'/></svg></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.9663em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9663em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span><span style="top:-3.2523em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.1522em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.9663em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9663em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span><span style="top:-3.2523em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.1522em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span><span class="mspace newline"></span></span></span></span></p>
<p>求解这个方程组很简单，改写成矩阵形式就行：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mover accent="true"><mrow><msub><mi>p</mi><mn>1</mn></msub><msub><mi>p</mi><mn>0</mn></msub></mrow><mo>⃗</mo></mover></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mover accent="true"><mrow><msub><mi>p</mi><mn>2</mn></msub><msub><mi>p</mi><mn>0</mn></msub></mrow><mo>⃗</mo></mover></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mover accent="true"><mi>N</mi><mo>⃗</mo></mover></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>⋅</mo><mover accent="true"><mi>T</mi><mo>⃗</mo></mover><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>u</mi><mn>1</mn></msub><mo>−</mo><msub><mi>u</mi><mn>0</mn></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>u</mi><mn>2</mn></msub><mo>−</mo><msub><mi>u</mi><mn>0</mn></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\begin{bmatrix}\vec{p_1p_0}\\
\vec{p_2p_0}\\
\vec{N}
\end{bmatrix}
\cdot\vec{T}=\begin{bmatrix}u_1-u_0\\u_2-u_0\\0\end{bmatrix}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3.7263em;vertical-align:-1.6132em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"></span><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.667em' height='3.600em' viewBox='0 0 667 3600'><path d='M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84
H403z M403 1759 V0 H319 V1759 v0 v1759 h84z'/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.1132em;"><span style="top:-4.2732em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2355em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z'/></svg></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span></span></span></span></span></span></span></span><span style="top:-3.0732em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2355em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z'/></svg></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span></span></span></span></span></span></span></span><span style="top:-1.7468em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9663em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span><span style="top:-3.2523em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.1522em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.6132em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"></span><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.667em' height='3.600em' viewBox='0 0 667 3600'><path d='M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z
M347 1759 V0 H263 V1759 v0 v1759 h84z'/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.9663em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9663em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span><span style="top:-3.2523em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.1522em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"></span><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.667em' height='3.600em' viewBox='0 0 667 3600'><path d='M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84
H403z M403 1759 V0 H319 V1759 v0 v1759 h84z'/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"></span><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.667em' height='3.600em' viewBox='0 0 667 3600'><path d='M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z
M347 1759 V0 H263 V1759 v0 v1759 h84z'/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mover accent="true"><mi>T</mi><mo>⃗</mo></mover><mo>=</mo><msup><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mover accent="true"><mrow><msub><mi>p</mi><mn>1</mn></msub><msub><mi>p</mi><mn>0</mn></msub></mrow><mo>⃗</mo></mover></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mover accent="true"><mrow><msub><mi>p</mi><mn>2</mn></msub><msub><mi>p</mi><mn>0</mn></msub></mrow><mo>⃗</mo></mover></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mover accent="true"><mi>N</mi><mo>⃗</mo></mover></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mrow><mo>−</mo><mn>1</mn></mrow></msup><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>u</mi><mn>1</mn></msub><mo>−</mo><msub><mi>u</mi><mn>0</mn></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>u</mi><mn>2</mn></msub><mo>−</mo><msub><mi>u</mi><mn>0</mn></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\vec{T}=\begin{bmatrix}\vec{p_1p_0}\\
\vec{p_2p_0}\\
\vec{N}
\end{bmatrix}^{-1}\begin{bmatrix}u_1-u_0\\u_2-u_0\\0\end{bmatrix}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9663em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9663em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span><span style="top:-3.2523em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.1522em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.9303em;vertical-align:-1.6132em;"></span><span class="minner"><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"></span><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.667em' height='3.600em' viewBox='0 0 667 3600'><path d='M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84
H403z M403 1759 V0 H319 V1759 v0 v1759 h84z'/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.1132em;"><span style="top:-4.2732em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2355em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z'/></svg></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span></span></span></span></span></span></span></span><span style="top:-3.0732em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2355em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z'/></svg></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span></span></span></span></span></span></span></span><span style="top:-1.7468em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9663em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span><span style="top:-3.2523em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.1522em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.6132em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"></span><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.667em' height='3.600em' viewBox='0 0 667 3600'><path d='M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z
M347 1759 V0 H263 V1759 v0 v1759 h84z'/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span></span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:2.3172em;"><span style="top:-4.5661em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"></span><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.667em' height='3.600em' viewBox='0 0 667 3600'><path d='M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84
H403z M403 1759 V0 H319 V1759 v0 v1759 h84z'/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"></span><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.667em' height='3.600em' viewBox='0 0 667 3600'><path d='M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z
M347 1759 V0 H263 V1759 v0 v1759 h84z'/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>对于B向量也可以如法炮制：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mover accent="true"><mi>B</mi><mo>⃗</mo></mover><mo>=</mo><msup><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mover accent="true"><mrow><msub><mi>p</mi><mn>1</mn></msub><msub><mi>p</mi><mn>0</mn></msub></mrow><mo>⃗</mo></mover></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mover accent="true"><mrow><msub><mi>p</mi><mn>2</mn></msub><msub><mi>p</mi><mn>0</mn></msub></mrow><mo>⃗</mo></mover></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mover accent="true"><mi>N</mi><mo>⃗</mo></mover></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mrow><mo>−</mo><mn>1</mn></mrow></msup><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>v</mi><mn>1</mn></msub><mo>−</mo><msub><mi>v</mi><mn>0</mn></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>v</mi><mn>2</mn></msub><mo>−</mo><msub><mi>v</mi><mn>0</mn></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\vec{B}=\begin{bmatrix}\vec{p_1p_0}\\
\vec{p_2p_0}\\
\vec{N}
\end{bmatrix}^{-1}\begin{bmatrix}v_1-v_0\\v_2-v_0\\0\end{bmatrix}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9663em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9663em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span><span style="top:-3.2523em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.1522em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.9303em;vertical-align:-1.6132em;"></span><span class="minner"><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"></span><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.667em' height='3.600em' viewBox='0 0 667 3600'><path d='M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84
H403z M403 1759 V0 H319 V1759 v0 v1759 h84z'/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.1132em;"><span style="top:-4.2732em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2355em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z'/></svg></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span></span></span></span></span></span></span></span><span style="top:-3.0732em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2355em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z'/></svg></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span></span></span></span></span></span></span></span><span style="top:-1.7468em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9663em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span><span style="top:-3.2523em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.1522em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.6132em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"></span><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.667em' height='3.600em' viewBox='0 0 667 3600'><path d='M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z
M347 1759 V0 H263 V1759 v0 v1759 h84z'/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span></span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:2.3172em;"><span style="top:-4.5661em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"></span><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.667em' height='3.600em' viewBox='0 0 667 3600'><path d='M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84
H403z M403 1759 V0 H319 V1759 v0 v1759 h84z'/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"></span><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.667em' height='3.600em' viewBox='0 0 667 3600'><path d='M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z
M347 1759 V0 H263 V1759 v0 v1759 h84z'/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>这样我们就求出T向量和B向量了，带上原本的N向量就可以构建出一个切线空间了。</p>
<p>需要注意的是，我们这里使用到了三角形的顶点信息，所以我这里顺带将之前的MVP矩阵变换单独封装成了vertex shader，顺带可以跟我们现在写的fragment shader数据互通。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">float</span> u = vertex.texcoord.x;</span><br><span class="line"><span class="type">float</span> v = vertex.texcoord.y;</span><br><span class="line"><span class="type">float</span> w = material-&gt;map_Bump[mipmap_level].<span class="built_in">width</span>();</span><br><span class="line"><span class="type">float</span> h = material-&gt;map_Bump.<span class="built_in">height</span>();</span><br><span class="line">TGAColor uv = <span class="built_in">bilinearInterpolate</span>(material-&gt;map_Bump,</span><br><span class="line">    u * w, v * h);</span><br><span class="line"></span><br><span class="line"><span class="function">myEigen::Vector3f <span class="title">uv_vec</span><span class="params">((<span class="type">double</span>)uv.bgra[<span class="number">2</span>] * <span class="number">2.0f</span> / <span class="number">255.0</span> - <span class="number">1.0f</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">                         (<span class="type">double</span>)uv.bgra[<span class="number">1</span>] * <span class="number">2.0f</span> / <span class="number">255.0</span> - <span class="number">1.0f</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">                         (<span class="type">double</span>)uv.bgra[<span class="number">0</span>] * <span class="number">2.0f</span> / <span class="number">255.0</span> - <span class="number">1.0f</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">myEigen::Vector3f			n = uv_vec.<span class="built_in">Normalize</span>();</span><br><span class="line"></span><br><span class="line">myEigen::Vector3f        p1p0 = (tri_cameraspace.vertex[<span class="number">1</span>].vertex - tri_cameraspace.vertex[<span class="number">0</span>].vertex).<span class="built_in">xyz</span>();</span><br><span class="line">myEigen::Vector3f        p2p0 = (tri_cameraspace.vertex[<span class="number">2</span>].vertex - tri_cameraspace.vertex[<span class="number">0</span>].vertex).<span class="built_in">xyz</span>();</span><br><span class="line">myEigen::Vector3f	       fu = myEigen::<span class="built_in">Vector3f</span>(tri_cameraspace.vertex[<span class="number">1</span>].texcoord.x - tri_cameraspace.vertex[<span class="number">0</span>].texcoord.x,</span><br><span class="line">                                                  tri_cameraspace.vertex[<span class="number">2</span>].texcoord.x - tri_cameraspace.vertex[<span class="number">0</span>].texcoord.x, <span class="number">0.0f</span>);</span><br><span class="line">myEigen::Vector3f	       fv = myEigen::<span class="built_in">Vector3f</span>(tri_cameraspace.vertex[<span class="number">1</span>].texcoord.y - tri_cameraspace.vertex[<span class="number">0</span>].texcoord.y,</span><br><span class="line">                                                  tri_cameraspace.vertex[<span class="number">2</span>].texcoord.y - tri_cameraspace.vertex[<span class="number">0</span>].texcoord.y, <span class="number">0.0f</span>);</span><br><span class="line">myEigen::Matrixf3x3         A = myEigen::<span class="built_in">Matrix3x3Transpose</span>(myEigen::<span class="built_in">Matrixf3x3</span>(p1p0, p2p0, Normal));</span><br><span class="line"><span class="keyword">auto</span>				A_inverse = myEigen::<span class="built_in">Matrix3x3Inverse</span>(A);</span><br><span class="line"><span class="keyword">auto</span>				A_inverse = myEigen::<span class="built_in">Matrix3x3Inverse</span>(A);</span><br><span class="line"></span><br><span class="line">myEigen::Vector3f           T = A_inverse * fu;</span><br><span class="line">myEigen::Vector3f           B = A_inverse * fv;</span><br><span class="line"></span><br><span class="line"><span class="function">myEigen::Matrixf3x3 <span class="title">TBN</span><span class="params">(T.Normalize(), B.Normalize(), Normal)</span></span>;</span><br><span class="line">Normal = (TBN * n).<span class="built_in">Normalize</span>();</span><br></pre></td></tr></table></figure>
<p>我们来看看渲染结果：</p>
<p><img src="https://raw.githubusercontent.com/chiuhoukazusa/blog_img/main/202301180450559.gif" alt="Normalmap"></p>
<p>可以跟之前的结果对比一下，最明显的差别就是靴子上和手臂袖子上的褶皱。可以说效果非常的棒。</p>
<h3 id="Mipmap">Mipmap</h3>
<p>本章的最后一项内容就是mipmap。</p>
<p>当我们采样的贴图精度过大，而渲染区域又过小的时候，我们的采样结果会出现失真。</p>
<p>什么情况才叫过大？就是当屏幕上跨越一格像素，对应的纹理采样跨越了远超一格像素的时候。就像我们现在渲染的梅琳娜，她使用的纹理都是4096x4096的，而我们渲染的图片也就700x700的大小，毫无疑问就会出现这种摩尔纹现象，但是比较轻微。</p>
<p><img src="https://raw.githubusercontent.com/chiuhoukazusa/blog_img/main/202301180450641.gif" alt="mipmap演示"></p>
<p>可以参考左边的图片，产生的这种纹路我们称之为摩尔纹，是一种失真的表现，而我们对应的反走样策略就是mipmap。</p>
<p>可以对比左右两张图来观察mipmap做了什么，实际上mipmap的就是在远处将贴图精度适当降低，达到一种“模糊”的效果。</p>
<p>在gpu渲染中，mipmap的生成属于是gpu集成的算法，在opengl里只要寥寥几行就可以自动开启mipmap，而现在我们需要聚焦mipmap的相关算法。</p>
<p>其实mipmap的算法说起来非常的简单，我们只需要在读取纹理的时候自动生成低精度的纹理即可，假设我们有一张1024x1024的纹理，那么我们读取这个纹理的时候会自动在内存中创建512x512、256x256、128x128一直到1x1的对应纹理，至于这个过程怎么创建，其实就是每四格像素取平均合成一个像素即可。当我们需要采样纹理的时候，我们就会从对应的mipmap层级的纹理进行采样。</p>
<p>我们先把容易的部分也就是加载mipmap的代码写好：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">calculate_mipmaplevels</span><span class="params">(<span class="type">int</span> mipmap_width, <span class="type">int</span> mipmap_height)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> mipmap_levels = <span class="number">1</span>;</span><br><span class="line">	<span class="type">int</span> size = std::<span class="built_in">min</span>(mipmap_width, mipmap_height);</span><br><span class="line">	<span class="keyword">while</span> (size &gt; <span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		mipmap_levels++;</span><br><span class="line">		size = std::<span class="built_in">max</span>(<span class="number">1</span>, size / <span class="number">2</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> mipmap_levels;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">std::vector&lt;TGAImage&gt; <span class="title">generateMipmap</span><span class="params">(<span class="type">const</span> TGAImage&amp; texture)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	std::vector&lt;TGAImage&gt; mipmap;</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> mipmap_width = texture.<span class="built_in">width</span>();</span><br><span class="line">	<span class="type">int</span> mipmap_height = texture.<span class="built_in">height</span>();</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> mipmap_levels = <span class="built_in">calculate_mipmaplevels</span>(mipmap_width, mipmap_height);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> level = <span class="number">0</span>; level &lt; mipmap_levels; level++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="function">TGAImage <span class="title">mipmap_level_data</span><span class="params">(mipmap_width, mipmap_height, TGAImage::RGB)</span></span>;</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> y = <span class="number">0</span>; y &lt; mipmap_height; y++)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">for</span> (<span class="type">int</span> x = <span class="number">0</span>; x &lt; mipmap_width; x++)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="type">int</span> image_x = x * texture.<span class="built_in">width</span>() / mipmap_width;</span><br><span class="line">				<span class="type">int</span> image_y = y * texture.<span class="built_in">height</span>() / mipmap_height;</span><br><span class="line">				TGAColor pixel = texture.<span class="built_in">get</span>(image_x, image_y);</span><br><span class="line"></span><br><span class="line">				mipmap_level_data.<span class="built_in">set</span>(x, y, pixel);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		mipmap.<span class="built_in">push_back</span>(mipmap_level_data);</span><br><span class="line"></span><br><span class="line">		mipmap_width = std::<span class="built_in">max</span>(<span class="number">1</span>, mipmap_width / <span class="number">2</span>);</span><br><span class="line">		mipmap_height = std::<span class="built_in">max</span>(<span class="number">1</span>, mipmap_height / <span class="number">2</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> mipmap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>难点是采样的时候怎么计算对应的mipmap层级，参考下图：</p>
<p><img src="https://raw.githubusercontent.com/chiuhoukazusa/blog_img/main/202301180450735.png" alt="mipmaplevel"></p>
<p>我们需要知道在屏幕空间中跨越一格像素的时候，uv的增量是多少，也就是uv的变化量的模长，然后在生成好的mipmap中找到对应的纹理，使得屏幕空间跨越一格像素时，uv的增量接近于1。</p>
<p>那么问题就在于我们怎么访问到一格像素的相邻像素，实际上，在现代的计算机gpu渲染中，并不是1个1个像素进行渲染的，比较常见的会使用2x2的像素进行渲染，对于这4个像素，我们会计算ddx和ddy，也就是x方向上跨越一格像素时uv的变化量以及y方向上跨越一格像素时uv的变化量（实际上不一定是uv的变化量，可以换成任意顶点属性的变化量），然后对于这4个像素我们会共用ddx和ddy的数值。</p>
<p>那么我们现在要改造一下我们的光栅化代码，从原本的1个像素1个像素渲染的方式改进为一次传入四个像素。</p>
<p>因为edge walking的改造相对有点难度，所以我们将光栅化方式全面换成edge equation，并且对edge equation进行修改：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">rasterizer::rasterize_edge_equation</span><span class="params">(<span class="type">const</span> Triangle&amp; m, IShader&amp; shader, <span class="type">const</span> std::array&lt;myEigen::Vector4f, <span class="number">3</span>&gt;&amp; clipSpacePos)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> boundingTop = std::<span class="built_in">ceil</span>(std::<span class="built_in">max</span>(&#123; m.vertex[<span class="number">0</span>].vertex.y, m.vertex[<span class="number">1</span>].vertex.y, m.vertex[<span class="number">2</span>].vertex.y &#125;));</span><br><span class="line">	<span class="type">int</span> boundingBottom = std::<span class="built_in">floor</span>(std::<span class="built_in">min</span>(&#123; m.vertex[<span class="number">0</span>].vertex.y, m.vertex[<span class="number">1</span>].vertex.y, m.vertex[<span class="number">2</span>].vertex.y &#125;));</span><br><span class="line">	<span class="type">int</span> boundingRight = std::<span class="built_in">ceil</span>(std::<span class="built_in">max</span>(&#123; m.vertex[<span class="number">0</span>].vertex.x, m.vertex[<span class="number">1</span>].vertex.x, m.vertex[<span class="number">2</span>].vertex.x &#125;));</span><br><span class="line">	<span class="type">int</span> boundingLeft = std::<span class="built_in">floor</span>(std::<span class="built_in">min</span>(&#123; m.vertex[<span class="number">0</span>].vertex.x, m.vertex[<span class="number">1</span>].vertex.x, m.vertex[<span class="number">2</span>].vertex.x &#125;));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> y = boundingBottom; y &lt; boundingTop; y += <span class="number">2</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> x = boundingLeft; x &lt; boundingRight; x += <span class="number">2</span>) </span><br><span class="line">		&#123;</span><br><span class="line">			Vertex pixel[<span class="number">2</span>][<span class="number">2</span>];</span><br><span class="line">			<span class="keyword">for</span> (<span class="type">int</span> a : &#123;x, x + <span class="number">1</span>&#125;)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">for</span> (<span class="type">int</span> b : &#123;y, y + <span class="number">1</span>&#125;)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="keyword">if</span> (<span class="built_in">insideTriangle</span>(m, (<span class="type">float</span>)a + <span class="number">0.5</span>, (<span class="type">float</span>)b + <span class="number">0.5</span>))</span><br><span class="line">					&#123;</span><br><span class="line">						pixel[a - x][b - y] =</span><br><span class="line">							<span class="built_in">barycentricPerspectiveLerp</span>(m, myEigen::<span class="built_in">Vector2f</span>(a + <span class="number">0.5</span>, b + <span class="number">0.5</span>), clipSpacePos);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="type">float</span> ddx = <span class="number">-1</span>;</span><br><span class="line">			<span class="type">float</span> ddy = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">for</span> (<span class="type">int</span> i : &#123;<span class="number">0</span>, <span class="number">1</span>&#125;)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span> (!pixel[i][<span class="number">0</span>].<span class="built_in">empty</span>() &amp;&amp; !pixel[i][<span class="number">1</span>].<span class="built_in">empty</span>())</span><br><span class="line">				&#123;</span><br><span class="line">					ddx = std::<span class="built_in">max</span>(<span class="built_in">fabs</span>((pixel[i][<span class="number">1</span>].texcoord - pixel[i][<span class="number">0</span>].texcoord).<span class="built_in">Length</span>()), ddx);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> (!pixel[<span class="number">0</span>][i].<span class="built_in">empty</span>() &amp;&amp; !pixel[<span class="number">1</span>][i].<span class="built_in">empty</span>())</span><br><span class="line">				&#123;</span><br><span class="line">					ddy = std::<span class="built_in">max</span>(<span class="built_in">fabs</span>((pixel[<span class="number">0</span>][i].texcoord - pixel[<span class="number">1</span>][i].texcoord).<span class="built_in">Length</span>()), ddy);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			shader.<span class="built_in">setddx</span>(ddx);</span><br><span class="line">			shader.<span class="built_in">setddy</span>(ddy);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">for</span> (<span class="type">int</span> a : &#123;<span class="number">0</span>, <span class="number">1</span>&#125;)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">for</span> (<span class="type">int</span> b : &#123;<span class="number">0</span>, <span class="number">1</span>&#125;)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="keyword">if</span> (pixel[a][b].<span class="built_in">empty</span>()) <span class="keyword">continue</span>;</span><br><span class="line">					pixel[a][b].vertexColor = shader.<span class="built_in">FragmentShader</span>(pixel[a][b]);</span><br><span class="line">					<span class="keyword">if</span> (pixel[a][b].vertex.z &gt; z_buffer[<span class="built_in">get_index</span>(x + a, y + b)])</span><br><span class="line">					&#123;</span><br><span class="line">						image.<span class="built_in">set</span>(x + a, y + b, pixel[a][b].vertexColor);</span><br><span class="line">						z_buffer[<span class="built_in">get_index</span>(x + a, y + b)] = pixel[a][b].vertex.z;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们使用-1的ddx和ddy值用来表示ddx和ddy不存在的情况，也就是四个像素有几个是空像素的情况，这时候我们直接使用长宽最大的mipmap即可。</p>
<p>然后是采样mipmap的过程：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">myEigen::Vector3f <span class="title">sample</span><span class="params">(<span class="type">const</span> myEigen::Vector2f texcoord, <span class="type">const</span> std::vector&lt;TGAImage&gt;&amp; texture)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!texture.<span class="built_in">empty</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="type">int</span> mipmap_level = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">if</span> (ddx != <span class="number">-1.0f</span> || ddy != <span class="number">-1.0f</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">auto</span>&amp; map : texture)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="type">float</span> d = std::<span class="built_in">max</span>(ddx * map.<span class="built_in">width</span>(), ddy * map.<span class="built_in">height</span>());</span><br><span class="line">				<span class="keyword">if</span> (std::<span class="built_in">max</span>((<span class="type">int</span>)std::<span class="built_in">log2</span>(d), <span class="number">0</span>) == <span class="number">0</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					mipmap_level = i;</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				i++;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		TGAColor var = <span class="built_in">bilinearInterpolate</span>(texture[mipmap_level],</span><br><span class="line">			texcoord.x * texture[mipmap_level].<span class="built_in">width</span>(),</span><br><span class="line">			texcoord.y * texture[mipmap_level].<span class="built_in">height</span>());</span><br><span class="line">		<span class="keyword">return</span> myEigen::<span class="built_in">Vector3f</span>(var.bgra[<span class="number">2</span>] / <span class="number">255.0</span>, var.bgra[<span class="number">1</span>] / <span class="number">255.0</span>, var.bgra[<span class="number">0</span>] / <span class="number">255.0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123; <span class="keyword">return</span> myEigen::<span class="built_in">Vector3f</span>(<span class="number">-200</span>, <span class="number">-200</span>, <span class="number">-200</span>); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样我们的mipmap基本完成了，让我们来看看结果：</p>
<p><img src="https://raw.githubusercontent.com/chiuhoukazusa/blog_img/main/202301180450833.gif" alt="MipMap"></p>
<p>区别不是很大，主要是衣服上的渲染有点差别，原本的法线贴图在衣服上有一定的摩尔纹现象，不过需要改成白模渲染才容易看出来。</p>
<h4 id="三线性插值-Trilinear-interpolation">三线性插值(Trilinear interpolation)</h4>
<p>如果跟着写了之前的代码就会发现一个问题，我们判断mipmaplevel的方式是离散的，也就是不平滑的，假设我们计算出来的mipmaplevel是3.4，那么我们直接使用mipmaplevel为3的纹理进行采样，可实际上我们完全可以这么操作，在mipmaplevel为3和4的纹理上都进行一次采样，然后根据这个level的小数部分也就是0.4为插值权重对两次结果进行一次插值。</p>
<p>因为我们在纹理上采样的过程是双线性插值，我们实际上是进行了两次双线性插值，再将最终结果进行一次插值，所以这个过程被我们称作三线性插值。</p>
<p>我们来简单写一下，稍微改写下之前的函数：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">myEigen::Vector3f <span class="title">sample</span><span class="params">(<span class="type">const</span> myEigen::Vector2f texcoord, <span class="type">const</span> std::vector&lt;TGAImage&gt;&amp; texture)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!texture.<span class="built_in">empty</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="type">float</span> mipmap_level = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">if</span> (ddx != <span class="number">-1.0f</span> || ddy != <span class="number">-1.0f</span>)</span><br><span class="line">		&#123;</span><br><span class="line">                  <span class="type">float</span> max_level = texture.<span class="built_in">size</span>() - <span class="number">1</span>;</span><br><span class="line">                  <span class="type">float</span> d = std::<span class="built_in">max</span>(ddx * texture[<span class="number">0</span>].<span class="built_in">width</span>(), ddy * texture[<span class="number">0</span>].<span class="built_in">height</span>());</span><br><span class="line">                  mipmap_level = std::<span class="built_in">log2</span>(d);</span><br><span class="line">                  <span class="keyword">if</span> (mipmap_level &lt; <span class="number">0</span>)</span><br><span class="line">                  &#123;</span><br><span class="line">                      mipmap_level = <span class="number">0</span>;</span><br><span class="line">                      TGAColor var = <span class="built_in">bilinearInterpolate</span>(texture[mipmap_level],</span><br><span class="line">                          texcoord.x * texture[mipmap_level].<span class="built_in">width</span>(),</span><br><span class="line">                          texcoord.y * texture[mipmap_level].<span class="built_in">height</span>());</span><br><span class="line">                      <span class="keyword">return</span> myEigen::<span class="built_in">Vector3f</span>(var.bgra[<span class="number">2</span>] / <span class="number">255.0</span>, var.bgra[<span class="number">1</span>] / <span class="number">255.0</span>, var.bgra[<span class="number">0</span>] / <span class="number">255.0</span>);</span><br><span class="line">                  &#125;</span><br><span class="line">                  <span class="keyword">if</span> (mipmap_level &gt; max_level)</span><br><span class="line">                  &#123;</span><br><span class="line">                      mipmap_level = max_level;</span><br><span class="line">                      TGAColor var = <span class="built_in">bilinearInterpolate</span>(texture[mipmap_level],</span><br><span class="line">                          texcoord.x * texture[mipmap_level].<span class="built_in">width</span>(),</span><br><span class="line">                          texcoord.y * texture[mipmap_level].<span class="built_in">height</span>());</span><br><span class="line">                      <span class="keyword">return</span> myEigen::<span class="built_in">Vector3f</span>(var.bgra[<span class="number">2</span>] / <span class="number">255.0</span>, var.bgra[<span class="number">1</span>] / <span class="number">255.0</span>, var.bgra[<span class="number">0</span>] / <span class="number">255.0</span>);</span><br><span class="line">                  &#125;                  </span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">              <span class="type">int</span> f_mipmap_level = <span class="built_in">floor</span>(mipmap_level);</span><br><span class="line">              <span class="type">int</span> c_mipmap_level = <span class="built_in">ceil</span>(mipmap_level);</span><br><span class="line"></span><br><span class="line">		TGAColor f_var = <span class="built_in">bilinearInterpolate</span>(texture[f_mipmap_level],</span><br><span class="line">			texcoord.x * texture[f_mipmap_level].<span class="built_in">width</span>(),</span><br><span class="line">			texcoord.y * texture[f_mipmap_level].<span class="built_in">height</span>());</span><br><span class="line">              TGAColor c_var = <span class="built_in">bilinearInterpolate</span>(texture[c_mipmap_level],</span><br><span class="line">                  texcoord.x * texture[c_mipmap_level].<span class="built_in">width</span>(),</span><br><span class="line">                  texcoord.y * texture[c_mipmap_level].<span class="built_in">height</span>());</span><br><span class="line">              TGAColor var = <span class="built_in">ColorLerp</span>(f_var, c_var, mipmap_level - f_mipmap_level);</span><br><span class="line">		<span class="keyword">return</span> myEigen::<span class="built_in">Vector3f</span>(var.bgra[<span class="number">2</span>] / <span class="number">255.0</span>, var.bgra[<span class="number">1</span>] / <span class="number">255.0</span>, var.bgra[<span class="number">0</span>] / <span class="number">255.0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123; <span class="keyword">return</span> myEigen::<span class="built_in">Vector3f</span>(<span class="number">-200</span>, <span class="number">-200</span>, <span class="number">-200</span>); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>基本上就差不多了，注意两个边界情况不需要使用三线性插值，让我们看下结果：</p>
<p><img src="https://raw.githubusercontent.com/chiuhoukazusa/blog_img/main/202301180450962.gif" alt="三线性插值"></p>
<p>在缩略图情况下看不出差别是正常的，我用photoshop放大看才能看出些许平滑感，实际上三线性插值在这里就是不明显，日后也许有渲染大型场景的机会，这时三线性插值甚至mipmap本身的影响都会比较明显。</p>
<h2 id="结语">结语</h2>
<p>基本上渲染出这张gif的时候我们的任务就基本完成了，下一节应该轮到阴影的渲染了，这又是一个大问题。</p>
<p>话说前面的一些文章有一些错误，我已经尽可能修改重新上传过了，但是文章一直没什么人看，我想可能跟我的文章的形式有关系，我的文章太长太综合了，等我结束这个系列后我会尽量就几个重点问题再写几篇文章，比如mipmap到三线性插值再到我们这里没有实现的各向异性过滤我会专门再开一篇文章讲一下，包括法线贴图原理我也觉得再开个专门文章讲一下比较好，反正今天之后更新频率会尽可能上去，最近忙的事情基本上告一段落了，除非我一整个寒假都在打火纹，不然文章的更新应该会有所保证。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="https://chiukoukazusa.github.io">Chiuhou</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://chiukoukazusa.github.io/2023/01/18/05.%E8%BD%BD%E5%85%A53D%E6%A8%A1%E5%9E%8B%E6%A8%A1%E5%9E%8B%E5%8A%A0%E8%BD%BD%E4%B8%8E%E7%BA%B9%E7%90%86%E6%98%A0%E5%B0%84/">https://chiukoukazusa.github.io/2023/01/18/05.%E8%BD%BD%E5%85%A53D%E6%A8%A1%E5%9E%8B%E6%A8%A1%E5%9E%8B%E5%8A%A0%E8%BD%BD%E4%B8%8E%E7%BA%B9%E7%90%86%E6%98%A0%E5%B0%84/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="/img/favicon.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2022/10/16/04.%E5%9C%A8MVP%E4%B9%8B%E5%90%8E%E8%A3%81%E5%89%AA%E3%80%81%E4%B8%89%E8%A7%92%E5%BD%A2%E5%85%89%E6%A0%85%E5%8C%96%E4%B8%8E%E6%B7%B1%E5%BA%A6%E6%B5%8B%E8%AF%95%20github/"><img class="next-cover" src="/img/favicon.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">04.在MVP之后裁剪、三角形光栅化与深度测试</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/favicon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Chiuhou</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">6</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/chiuhoukazusa"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/chiuhoukazusa" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="/chiuhoukazusa@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">Fear the science.</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">05.载入3D模型|模型加载、简单着色与纹理映射</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%AC%E9%A1%B9%E7%9B%AE%E4%BB%A3%E7%A0%81%E5%B7%B2%E6%89%98%E7%AE%A1%E8%87%B3github%EF%BC%8C%E5%B0%86%E4%BC%9A%E9%9A%8F%E7%9D%80%E5%8D%9A%E5%AE%A2%E5%AE%9E%E6%97%B6%E6%9B%B4%E6%96%B0%E8%BF%9B%E5%BA%A6"><span class="toc-number">1.1.</span> <span class="toc-text">本项目代码已托管至github，将会随着博客实时更新进度</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.2.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#OBJ-MTL%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F"><span class="toc-number">1.3.</span> <span class="toc-text">OBJ-MTL文件格式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%BB%E5%8F%96OBJ%E6%96%87%E4%BB%B6"><span class="toc-number">1.4.</span> <span class="toc-text">读取OBJ文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9D%80%E8%89%B2"><span class="toc-number">1.5.</span> <span class="toc-text">着色</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%82%B9%E5%85%89%E6%BA%90or%E5%B9%B3%E8%A1%8C%E5%85%89"><span class="toc-number">1.5.1.</span> <span class="toc-text">点光源or平行光</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Blinn-Phong%E7%9D%80%E8%89%B2%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.5.2.</span> <span class="toc-text">Blinn-Phong着色模型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%8F%91%E5%85%89"><span class="toc-number">1.5.2.1.</span> <span class="toc-text">自发光</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%85%89"><span class="toc-number">1.5.2.2.</span> <span class="toc-text">环境光</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%AB%E5%8F%8D%E5%B0%84"><span class="toc-number">1.5.2.3.</span> <span class="toc-text">漫反射</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AB%98%E5%85%89%E5%8F%8D%E5%B0%84"><span class="toc-number">1.5.2.4.</span> <span class="toc-text">高光反射</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9D%80%E8%89%B2%E7%BB%93%E6%9E%9C"><span class="toc-number">1.5.2.5.</span> <span class="toc-text">着色结果</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MTL%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F"><span class="toc-number">1.6.</span> <span class="toc-text">MTL文件格式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%B9%E7%90%86%E6%98%A0%E5%B0%84"><span class="toc-number">1.7.</span> <span class="toc-text">纹理映射</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%BB%E5%8F%96MTL%E6%96%87%E4%BB%B6"><span class="toc-number">1.7.1.</span> <span class="toc-text">读取MTL文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8C%E7%BA%BF%E6%80%A7%E6%8F%92%E5%80%BC"><span class="toc-number">1.7.2.</span> <span class="toc-text">双线性插值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%95%E7%BA%BF%E8%B4%B4%E5%9B%BE"><span class="toc-number">1.7.3.</span> <span class="toc-text">法线贴图</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%B9%E5%87%B8%E8%B4%B4%E5%9B%BE"><span class="toc-number">1.7.3.1.</span> <span class="toc-text">凹凸贴图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%95%E7%BA%BF%E8%B4%B4%E5%9B%BE-2"><span class="toc-number">1.7.3.2.</span> <span class="toc-text">法线贴图</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Mipmap"><span class="toc-number">1.7.4.</span> <span class="toc-text">Mipmap</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%89%E7%BA%BF%E6%80%A7%E6%8F%92%E5%80%BC-Trilinear-interpolation"><span class="toc-number">1.7.4.1.</span> <span class="toc-text">三线性插值(Trilinear interpolation)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%93%E8%AF%AD"><span class="toc-number">1.8.</span> <span class="toc-text">结语</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/01/18/05.%E8%BD%BD%E5%85%A53D%E6%A8%A1%E5%9E%8B%E6%A8%A1%E5%9E%8B%E5%8A%A0%E8%BD%BD%E4%B8%8E%E7%BA%B9%E7%90%86%E6%98%A0%E5%B0%84/" title="05.载入3D模型|模型加载、简单着色与纹理映射"><img src="/img/favicon.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="05.载入3D模型|模型加载、简单着色与纹理映射"/></a><div class="content"><a class="title" href="/2023/01/18/05.%E8%BD%BD%E5%85%A53D%E6%A8%A1%E5%9E%8B%E6%A8%A1%E5%9E%8B%E5%8A%A0%E8%BD%BD%E4%B8%8E%E7%BA%B9%E7%90%86%E6%98%A0%E5%B0%84/" title="05.载入3D模型|模型加载、简单着色与纹理映射">05.载入3D模型|模型加载、简单着色与纹理映射</a><time datetime="2023-01-17T21:09:00.000Z" title="Created 2023-01-18 05:09:00">2023-01-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/10/16/04.%E5%9C%A8MVP%E4%B9%8B%E5%90%8E%E8%A3%81%E5%89%AA%E3%80%81%E4%B8%89%E8%A7%92%E5%BD%A2%E5%85%89%E6%A0%85%E5%8C%96%E4%B8%8E%E6%B7%B1%E5%BA%A6%E6%B5%8B%E8%AF%95%20github/" title="04.在MVP之后裁剪、三角形光栅化与深度测试"><img src="/img/favicon.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="04.在MVP之后裁剪、三角形光栅化与深度测试"/></a><div class="content"><a class="title" href="/2022/10/16/04.%E5%9C%A8MVP%E4%B9%8B%E5%90%8E%E8%A3%81%E5%89%AA%E3%80%81%E4%B8%89%E8%A7%92%E5%BD%A2%E5%85%89%E6%A0%85%E5%8C%96%E4%B8%8E%E6%B7%B1%E5%BA%A6%E6%B5%8B%E8%AF%95%20github/" title="04.在MVP之后裁剪、三角形光栅化与深度测试">04.在MVP之后裁剪、三角形光栅化与深度测试</a><time datetime="2022-10-15T20:41:00.000Z" title="Created 2022-10-16 04:41:00">2022-10-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/09/23/03-HelloTrianglesMVP%E5%8F%98%E6%8D%A2/" title="03.HelloTrianglesMVP变换"><img src="/img/favicon.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="03.HelloTrianglesMVP变换"/></a><div class="content"><a class="title" href="/2022/09/23/03-HelloTrianglesMVP%E5%8F%98%E6%8D%A2/" title="03.HelloTrianglesMVP变换">03.HelloTrianglesMVP变换</a><time datetime="2022-09-23T03:32:28.000Z" title="Created 2022-09-23 11:32:28">2022-09-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/09/15/02-%E7%AE%80%E5%8D%953D%E6%95%B0%E5%AD%A6%E5%BA%93%E5%B0%81%E8%A3%85%E5%90%91%E9%87%8F%E7%B1%BB%E5%92%8C%E7%9F%A9%E9%98%B5%E7%B1%BB/" title="02.简单3D数学库封装向量类和矩阵类"><img src="/img/favicon.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="02.简单3D数学库封装向量类和矩阵类"/></a><div class="content"><a class="title" href="/2022/09/15/02-%E7%AE%80%E5%8D%953D%E6%95%B0%E5%AD%A6%E5%BA%93%E5%B0%81%E8%A3%85%E5%90%91%E9%87%8F%E7%B1%BB%E5%92%8C%E7%9F%A9%E9%98%B5%E7%B1%BB/" title="02.简单3D数学库封装向量类和矩阵类">02.简单3D数学库封装向量类和矩阵类</a><time datetime="2022-09-15T04:09:15.000Z" title="Created 2022-09-15 12:09:15">2022-09-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/08/09/01-%E4%B8%80%E5%88%87%E7%9A%84%E5%BC%80%E5%A7%8BBresenham%E7%AE%97%E6%B3%95%E7%BB%98%E5%88%B6%E7%BA%BF%E6%AE%B5/" title="01.一切的开始Bresenham算法绘制线段"><img src="/img/favicon.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="01.一切的开始Bresenham算法绘制线段"/></a><div class="content"><a class="title" href="/2022/08/09/01-%E4%B8%80%E5%88%87%E7%9A%84%E5%BC%80%E5%A7%8BBresenham%E7%AE%97%E6%B3%95%E7%BB%98%E5%88%B6%E7%BA%BF%E6%AE%B5/" title="01.一切的开始Bresenham算法绘制线段">01.一切的开始Bresenham算法绘制线段</a><time datetime="2022-08-08T17:30:38.000Z" title="Created 2022-08-09 01:30:38">2022-08-09</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By Chiuhou</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><div class="js-pjax"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex/dist/contrib/copy-tex.min.js"></script><script>(() => {
  document.querySelectorAll('#article-container span.katex-display').forEach(item => {
    btf.wrap(item, 'div', { class: 'katex-wrap'})
  })
})()</script></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>